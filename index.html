<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. Zhang's Mandarin 12 Flashcard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card-container {
            perspective: 1000px;
        }
        .card {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 1rem;
        }
        .card-face-back {
            transform: rotateY(180deg);
        }
        #login-overlay, #deck-selection-overlay, #teacher-dashboard-overlay, #teacher-code-overlay, #edit-card-modal, #delete-confirm-modal, #help-modal, #delete-student-confirm-modal, #add-card-modal, #settings-modal {
            z-index: 10;
        }
        .stats-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .stats-container.expanded {
            max-height: 1000px; /* Adjust as needed */
        }
        /* Spinner for loading state */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <!-- Login Screen -->
    <div id="login-overlay" class="absolute inset-0 bg-slate-100 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-lg text-center max-w-sm w-full relative">
            <h2 class="text-2xl font-bold text-blue-600 mb-2">Student Login</h2>
            <p class="text-gray-600 mb-6">Enter your Name and Student ID to begin.</p>
            <div class="space-y-3">
                <input id="student-name-input" type="text" placeholder="Your Full Name..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <input id="student-id-input" type="text" placeholder="Your Student ID..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button id="login-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                    <span id="login-btn-text">Login / Start</span>
                    <div id="login-spinner" class="loader hidden ml-3"></div>
                </button>
            </div>
            <p id="login-error" class="text-red-500 text-sm mt-2 h-4"></p>
            <p id="teacher-admin-link" class="absolute bottom-4 right-4 text-xs text-gray-400 hover:text-blue-500 cursor-pointer">Teacher Admin</p>
        </div>
    </div>

    <!-- Teacher Code Entry Screen -->
    <div id="teacher-code-overlay" class="absolute inset-0 bg-slate-100 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg text-center max-w-sm w-full relative">
            <h2 class="text-2xl font-bold text-blue-600 mb-2">Teacher Access</h2>
            <p class="text-gray-600 mb-6">Please enter the class code to view student data.</p>
            <div class="space-y-3">
                <input id="teacher-code-input" type="password" placeholder="Class Code..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button id="submit-teacher-code-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">Enter</button>
            </div>
            <p id="teacher-code-error" class="text-red-500 text-sm mt-2 h-4"></p>
            <button id="back-from-code-btn" class="text-sm text-gray-500 hover:text-red-500 font-semibold mt-6">Back</button>
        </div>
    </div>
    
    <!-- Deck Selection Screen -->
    <div id="deck-selection-overlay" class="absolute inset-0 bg-slate-100 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg text-center max-w-sm w-full relative">
            <div id="open-settings-btn" title="Customize daily goals" class="absolute top-4 right-4 text-gray-400 hover:text-blue-500 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </div>
            <h2 id="welcome-message" class="text-2xl font-bold text-blue-600 mb-2">Welcome!</h2>
            <p id="deck-selection-message" class="text-gray-600 mb-6">Please select a deck to begin your session.</p>
            <div id="deck-buttons" class="space-y-3">
                <button data-deck="hsk2" class="deck-btn w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors">HSK 2</button>
                <button data-deck="hsk3" class="deck-btn w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 transition-colors">HSK 3</button>
                <button data-deck="hsk4" class="deck-btn w-full bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-600 transition-colors">HSK 4</button>
                <button data-deck="complete" class="deck-btn w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">Complete</button>
            </div>
             <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-500 font-semibold mt-6">Log Out</button>
        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacher-dashboard-overlay" class="absolute inset-0 bg-slate-100 p-4 md:p-8 hidden">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg max-w-4xl w-full mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-600">Teacher Dashboard</h2>
                <button id="back-to-login-screen-btn" class="text-sm text-gray-500 hover:text-red-500 font-semibold">Back to Login</button>
            </div>
            <div id="student-list-container" class="space-y-2 max-h-[70vh] overflow-y-auto">
                <!-- Student list will be populated here -->
            </div>
        </div>
    </div>


    <!-- Main App -->
    <div id="app-container" class="max-w-2xl w-full mx-auto p-4 md:p-6 bg-white rounded-2xl shadow-lg hidden">
        <header class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg -m-2">
             <div class="flex justify-between items-center">
                <h1 id="deck-title" class="text-3xl font-bold text-blue-600">Flashcard Deck</h1>
                 <div class="flex items-center space-x-4">
                    <button id="change-deck-btn" class="text-sm text-gray-500 hover:text-blue-500 font-semibold">Change Deck</button>
                    <div id="help-icon" title="How ratings work" class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 font-bold cursor-pointer hover:bg-blue-200 hover:text-blue-700 transition-colors text-sm">?</div>
                </div>
            </div>
            <p id="student-id-display" class="text-left text-gray-500 text-sm mt-1"></p>
            <p id="deck-stats" class="text-center text-gray-500 mt-2">Loading stats...</p>
            <p id="daily-goals-stats" class="text-center text-gray-600 font-semibold text-sm mt-1"></p>
            <nav class="flex justify-center border-b mt-4">
                <button id="review-tab-btn" class="px-6 py-2 font-semibold text-blue-600 border-b-2 border-blue-600">Review</button>
                <button id="edit-tab-btn" class="px-6 py-2 font-semibold text-gray-500">Edit</button>
            </nav>
        </header>

        <main>
            <!-- Review Section -->
            <div id="review-section">
                <div id="card-area" class="card-container h-64">
                     <div id="no-cards-message" class="hidden text-center text-gray-500 pt-20">
                        <p class="font-semibold text-lg">Deck is empty!</p>
                        <p>Go to the "Edit" tab to add your first card.</p>
                    </div>
                    <div id="all-done-message" class="hidden text-center text-gray-500 pt-20">
                        <p class="font-semibold text-lg">All done for now!</p>
                        <p>Come back later to review more cards.</p>
                    </div>
                    <div id="current-card" class="card w-full h-full rounded-lg shadow-md">
                        <div class="card-face card-face-front bg-white border-2 border-gray-200 rounded-lg p-4">
                            <p id="card-front" class="text-xl text-center"></p>
                        </div>
                        <div class="card-face card-face-back bg-blue-100 border-2 border-blue-200 rounded-lg p-4">
                            <p id="card-back" class="text-xl text-center"></p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div id="action-buttons" class="mt-6 flex flex-col items-center">
                    <button id="show-answer-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow-sm">Show Answer</button>
                    <div id="rating-buttons" class="hidden w-full grid grid-cols-4 gap-3 mt-4">
                        <button data-rating="again" class="rating-btn bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition-colors shadow-sm">Again</button>
                        <button data-rating="hard" class="rating-btn bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition-colors shadow-sm">Hard</button>
                        <button data-rating="good" class="rating-btn bg-yellow-500 text-white py-3 rounded-lg hover:bg-yellow-600 transition-colors shadow-sm">Good</button>
                        <button data-rating="easy" class="rating-btn bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-colors shadow-sm">Easy</button>
                    </div>
                </div>
            </div>

            <!-- Edit Deck Section -->
            <div id="edit-deck-section" class="hidden">
                <div class="flex justify-end mb-4">
                     <button id="open-add-card-modal-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow-sm">+ Add New Card</button>
                </div>
                <div class="border rounded-lg max-h-80 overflow-y-auto bg-slate-50">
                    <div id="card-list-container" class="divide-y divide-slate-200">
                        <!-- Card list will be dynamically populated here -->
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Add Card Modal -->
    <div id="add-card-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-lg w-full">
            <h3 class="text-xl font-bold text-blue-600 mb-4">Add New Card</h3>
            <form id="add-card-form">
                <div class="space-y-4">
                    <div>
                        <label for="front" class="block text-sm font-medium text-gray-700 mb-1">Front</label>
                        <textarea id="front" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    <div>
                        <label for="back" class="block text-sm font-medium text-gray-700 mb-1">Back</label>
                        <textarea id="back" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
                <p id="add-card-feedback" class="text-green-600 text-center mt-4 h-5"></p>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-add-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Add Card</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Card Modal -->
    <div id="edit-card-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-lg w-full">
            <h3 class="text-xl font-bold text-blue-600 mb-4">Edit Card</h3>
            <div class="space-y-4">
                <div>
                    <label for="edit-front" class="block text-sm font-medium text-gray-700 mb-1">Front</label>
                    <textarea id="edit-front" rows="3" class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
                </div>
                <div>
                    <label for="edit-back" class="block text-sm font-medium text-gray-700 mb-1">Back</label>
                    <textarea id="edit-back" rows="3" class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-edit-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Card Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Are you sure?</h3>
            <p class="text-gray-600 mb-6">This card will be permanently deleted.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Delete</button>
            </div>
        </div>
    </div>

    <!-- Delete Student Confirmation Modal -->
    <div id="delete-student-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Delete Student?</h3>
            <p class="text-gray-600 mb-6">This will permanently delete all data for <strong id="student-name-to-delete"></strong>. This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-student-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-student-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Delete Student</button>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-blue-600">How Ratings Work</h3>
                <button id="close-help-btn" class="text-gray-400 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <ul class="space-y-4 text-gray-700">
                <li class="flex items-start"><div class="w-4 h-4 rounded-full bg-red-500 mr-3 mt-1 flex-shrink-0"></div><div><strong>Again:</strong> You didn't know the answer. The card will show up again in about 1 minute.</div></li>
                <li class="flex items-start"><div class="w-4 h-4 rounded-full bg-orange-500 mr-3 mt-1 flex-shrink-0"></div><div><strong>Hard:</strong> You struggled to remember. The card will come back sooner than "Good".</div></li>
                <li class="flex items-start"><div class="w-4 h-4 rounded-full bg-yellow-500 mr-3 mt-1 flex-shrink-0"></div><div><strong>Good:</strong> You remembered, but it took some effort. The review interval will increase significantly.</div></li>
                <li class="flex items-start"><div class="w-4 h-4 rounded-full bg-green-500 mr-3 mt-1 flex-shrink-0"></div><div><strong>Easy:</strong> You knew the answer instantly. The review interval will increase even more, pushing the card far into the future.</div></li>
            </ul>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full">
            <h3 class="text-xl font-bold text-blue-600 mb-6">Customize Daily Goals</h3>
            <div class="space-y-4">
                <div>
                    <label for="new-cards-goal-input" class="block text-sm font-medium text-gray-700 mb-1">New Cards Per Day</label>
                    <input id="new-cards-goal-input" type="number" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label for="reviews-goal-input" class="block text-sm font-medium text-gray-700 mb-1">Reviews Per Day</label>
                    <input id="reviews-goal-input" type="number" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <p id="settings-feedback" class="text-red-500 text-center mt-4 h-5"></p>
            <div class="mt-8 flex justify-end space-x-3">
                <button id="cancel-settings-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-settings-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save Goals</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, writeBatch, query, getDocs, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- DOM ELEMENTS ---
        const loginOverlay = document.getElementById('login-overlay');
        const studentIdInput = document.getElementById('student-id-input');
        const studentNameInput = document.getElementById('student-name-input');
        const loginBtn = document.getElementById('login-btn');
        const loginSpinner = document.getElementById('login-spinner');
        const loginBtnText = document.getElementById('login-btn-text');
        const loginError = document.getElementById('login-error');
        const deckSelectionOverlay = document.getElementById('deck-selection-overlay');
        const welcomeMessage = document.getElementById('welcome-message');
        const deckSelectionMessage = document.getElementById('deck-selection-message');
        const deckButtons = document.getElementById('deck-buttons');
        const logoutBtn = document.getElementById('logout-btn');
        const appContainer = document.getElementById('app-container');
        const studentIdDisplay = document.getElementById('student-id-display');
        const deckTitle = document.getElementById('deck-title');
        const changeDeckBtn = document.getElementById('change-deck-btn');
        const reviewTabBtn = document.getElementById('review-tab-btn');
        const editTabBtn = document.getElementById('edit-tab-btn');
        const reviewSection = document.getElementById('review-section');
        const editDeckSection = document.getElementById('edit-deck-section');
        const deckStatsEl = document.getElementById('deck-stats');
        const dailyGoalsStatsEl = document.getElementById('daily-goals-stats');
        const currentCardEl = document.getElementById('current-card');
        const cardFrontEl = document.getElementById('card-front');
        const cardBackEl = document.getElementById('card-back');
        const noCardsMessage = document.getElementById('no-cards-message');
        const allDoneMessage = document.getElementById('all-done-message');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const ratingButtons = document.getElementById('rating-buttons');
        const addCardForm = document.getElementById('add-card-form');
        const frontInput = document.getElementById('front');
        const backInput = document.getElementById('back');
        const addCardFeedback = document.getElementById('add-card-feedback');
        const cardListContainer = document.getElementById('card-list-container');
        // Modals
        const addCardModal = document.getElementById('add-card-modal');
        const openAddCardModalBtn = document.getElementById('open-add-card-modal-btn');
        const cancelAddBtn = document.getElementById('cancel-add-btn');
        const editCardModal = document.getElementById('edit-card-modal');
        const editFrontInput = document.getElementById('edit-front');
        const editBackInput = document.getElementById('edit-back');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteStudentConfirmModal = document.getElementById('delete-student-confirm-modal');
        const studentNameToDeleteEl = document.getElementById('student-name-to-delete');
        const cancelDeleteStudentBtn = document.getElementById('cancel-delete-student-btn');
        const confirmDeleteStudentBtn = document.getElementById('confirm-delete-student-btn');
        const helpModal = document.getElementById('help-modal');
        const helpIcon = document.getElementById('help-icon');
        const closeHelpBtn = document.getElementById('close-help-btn');
        const settingsModal = document.getElementById('settings-modal');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const newCardsGoalInput = document.getElementById('new-cards-goal-input');
        const reviewsGoalInput = document.getElementById('reviews-goal-input');
        const settingsFeedback = document.getElementById('settings-feedback');
        // Teacher Elements
        const teacherAdminLink = document.getElementById('teacher-admin-link');
        const teacherCodeOverlay = document.getElementById('teacher-code-overlay');
        const teacherCodeInput = document.getElementById('teacher-code-input');
        const submitTeacherCodeBtn = document.getElementById('submit-teacher-code-btn');
        const teacherCodeError = document.getElementById('teacher-code-error');
        const backFromCodeBtn = document.getElementById('back-from-code-btn');
        const teacherDashboardOverlay = document.getElementById('teacher-dashboard-overlay');
        const backToLoginScreenBtn = document.getElementById('back-to-login-screen-btn');
        const studentListContainer = document.getElementById('student-list-container');
        
        // --- FIREBASE & STATE ---
        let db, auth;
        let deck = [];
        let sessionQueue = [];
        let sessionRepeatPile = [];
        let sessionSeenCardIds = new Set();
        let currentCard = null;
        let userLoginId = null; 
        let deckId = null;
        let unsubscribeFromDeck; 
        let reviewStartTime = null;
        let dailyStats = { newCardsSeen: 0, reviewsDone: 0 };
        let cardIdToEditOrDelete = null;
        let studentToDelete = null;
        let userGoals = { newCards: 25, reviews: 50 };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        async function initializeFirebase() {
            try {
                let firebaseConfig;
                let initialAuthToken = null;

                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    firebaseConfig = JSON.parse(__firebase_config);
                    initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                } else {
                    firebaseConfig = {
                      apiKey: "AIzaSyDLb2nmy5HYNNNTdS87pdDqLZk7TkVK-Rc",
                      authDomain: "mand12cards.firebaseapp.com",
                      projectId: "mand12cards",
                      storageBucket: "mand12cards.appspot.com",
                      messagingSenderId: "916004335850",
                      appId: "1:916004335850:web:1a967ff0f3d26843f16793"
                    };
                }

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("PASTE_YOUR")) {
                     throw new Error("Firebase config not found. If deploying, please paste your project's firebaseConfig object.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                         try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                             console.error("Authentication failed:", error);
                             loginError.textContent = "Connection error.";
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loginError.textContent = error.message;
            }
        }
       
        const startUserSession = async (studentId, studentName) => {
            userLoginId = studentId;
            sessionStorage.setItem('userLoginId', userLoginId);

            const profileRef = doc(db, `artifacts/${appId}/public/data/students/${userLoginId}/profile/info`);
            const profileSnap = await getDoc(profileRef);
            
            if (!profileSnap.exists()) {
                await setDoc(profileRef, { name: studentName, createdAt: Date.now() });
            }
            
            const studentProfileRef = doc(db, `artifacts/${appId}/public/data/student_profiles/${userLoginId}`);
            const studentProfileSnap = await getDoc(studentProfileRef);
            if (!studentProfileSnap.exists()){
                 await setDoc(studentProfileRef, { name: studentName, studentId: userLoginId });
            }
            
            const profileData = (await getDoc(profileRef)).data();
            const userName = profileData.name || studentName;
            
            if (profileData.customGoals) {
                userGoals = profileData.customGoals;
            } else {
                userGoals = { newCards: 25, reviews: 50 };
            }

            welcomeMessage.textContent = `Welcome, ${userName}!`;
            loginOverlay.classList.add('hidden');
            
            const savedDeckId = sessionStorage.getItem('deckId');
            if (savedDeckId) {
                await handleDeckSelection(savedDeckId);
            } else {
                deckSelectionOverlay.classList.remove('hidden');
            }
        };

        const handleLogin = async () => {
            const enteredId = studentIdInput.value.trim();
            const enteredName = studentNameInput.value.trim();
            if (!enteredId || !enteredName) {
                loginError.textContent = "Please enter both your Name and Student ID.";
                return;
            }
            loginError.textContent = "";

            loginBtn.disabled = true;
            loginBtnText.textContent = "Logging In...";
            loginSpinner.classList.remove('hidden');

            try {
                if (enteredId === 'WynR29') {
                    loginOverlay.classList.add('hidden');
                    showTeacherDashboard();
                } else if (enteredId === 'CREATE_MASTER_DECKS') {
                    await populateMasterDecks();
                    loginError.textContent = 'Master decks have been created successfully!';
                }
                else {
                    await startUserSession(enteredId, enteredName);
                }
            } catch (error) {
                console.error("Login failed:", error);
                loginError.textContent = "Login failed. Please try again.";
            } finally {
                loginBtn.disabled = false;
                loginBtnText.textContent = "Login / Start";
                loginSpinner.classList.add('hidden');
            }
        };
        
        const handleLogout = () => {
            if (unsubscribeFromDeck) unsubscribeFromDeck();
            sessionStorage.removeItem('userLoginId');
            sessionStorage.removeItem('deckId');
            userLoginId = null; deckId = null; deck = []; currentCard = null;
            appContainer.classList.add('hidden');
            deckSelectionOverlay.classList.add('hidden');
            loginOverlay.classList.remove('hidden');
        };
        
        const getTodaysDateString = () => new Date().toISOString().split('T')[0];

        const loadDailyStatsForDeck = async () => {
            if (!userLoginId || !deckId) return;
            const statsRef = doc(db, `artifacts/${appId}/public/data/students/${userLoginId}/progress/${deckId}`);
            const statsSnap = await getDoc(statsRef);
            const todayStr = getTodaysDateString();

            if (statsSnap.exists() && statsSnap.data().lastSessionDate === todayStr) {
                dailyStats = statsSnap.data();
            } else {
                dailyStats = { newCardsSeen: 0, reviewsDone: 0, lastSessionDate: todayStr };
                await setDoc(statsRef, dailyStats);
            }
        };

        const updateDailyStatsInFirestore = async () => {
             if (!userLoginId || !deckId) return;
             const statsRef = doc(db, `artifacts/${appId}/public/data/students/${userLoginId}/progress/${deckId}`);
             await setDoc(statsRef, dailyStats, { merge: true });
        };
        
        const startReviewSession = async () => {
            await loadDailyStatsForDeck();

            const newCardsLimit = Math.max(0, userGoals.newCards - (dailyStats.newCardsSeen || 0));
            const reviewCardsLimit = Math.max(0, userGoals.reviews - (dailyStats.reviewsDone || 0));

            const newCards = deck.filter(c => c.status === 'new').slice(0, newCardsLimit);
            const reviewCards = deck.filter(c => c.status === 'practice' && c.nextReviewDate <= Date.now()).slice(0, reviewCardsLimit);
            
            sessionQueue = [...newCards, ...reviewCards].sort(() => Math.random() - 0.5); 
            sessionRepeatPile = [];
            sessionSeenCardIds = new Set();
            
            showNextCard();
        };

        const handleDeckSelection = async (selectedDeckId) => {
            deckButtons.querySelectorAll('button').forEach(btn => btn.disabled = true);
            deckSelectionMessage.textContent = `Preparing ${selectedDeckId.toUpperCase()} deck...`;
            
            deckId = selectedDeckId;
            sessionStorage.setItem('deckId', deckId);
            
            const deckNames = { hsk2: 'HSK 2', hsk3: 'HSK 3', hsk4: 'HSK 4', complete: 'Complete Deck' };
            deckTitle.textContent = deckNames[selectedDeckId] || 'Flashcard Deck';
            
            deckSelectionOverlay.classList.add('hidden');
            appContainer.classList.remove('hidden');
            studentIdDisplay.textContent = `Student ID: ${userLoginId}`;
            loadDeck();
            
            deckButtons.querySelectorAll('button').forEach(btn => btn.disabled = false);
            deckSelectionMessage.textContent = "Please select a deck to begin your session.";
        };

        const handleChangeDeck = () => {
            if (unsubscribeFromDeck) unsubscribeFromDeck(); 
            deck = []; sessionQueue = []; sessionRepeatPile = []; currentCard = null; deckId = null;
            sessionStorage.removeItem('deckId');
            appContainer.classList.add('hidden');
            deckSelectionOverlay.classList.remove('hidden');
        };

        const getMasterDeckCollectionPath = (dId = deckId) => `artifacts/${appId}/public/data/master_decks/${dId}/cards`;
        const getUserProgressCollectionPath = (sId = userLoginId) => `artifacts/${appId}/public/data/students/${sId}/card_progress`;
        const getUserPersonalDeckCollectionPath = (sId = userLoginId) => `artifacts/${appId}/public/data/students/${sId}/personal_decks/cards`;


        const loadDeck = async () => {
            if (!userLoginId || !deckId) return;
            
            const masterDeckCollection = collection(db, getMasterDeckCollectionPath());
            const userProgressCollection = collection(db, getUserProgressCollectionPath());

            const [masterSnapshot, progressSnapshot] = await Promise.all([
                getDocs(masterDeckCollection),
                getDocs(query(collection(db, getUserProgressCollectionPath()), where('deckId', '==', deckId)))
            ]);

            const userProgress = {};
            progressSnapshot.forEach(doc => {
                userProgress[doc.id] = doc.data();
            });

            deck = masterSnapshot.docs.map(doc => {
                const masterCard = { id: doc.id, ...doc.data() };
                const progress = userProgress[masterCard.id];
                return { ...masterCard, ...progress };
            });

            switchTab('review');
        };
        
        const updateStatsUI = () => {
            const newCountInQueue = sessionQueue.filter(c => (!c.status || c.status === 'new') && !sessionSeenCardIds.has(c.id)).length;
            const reviewCountInQueue = sessionQueue.filter(c => c.status === 'practice').length;
            const repeatCount = sessionRepeatPile.length;

            deckStatsEl.innerHTML = `
                <span class="text-blue-600 font-semibold">New: ${newCountInQueue}</span> | 
                <span class="text-green-600 font-semibold">Practice: ${reviewCountInQueue}</span> |
                <span class="text-red-600 font-semibold">Repeating: ${repeatCount}</span>
            `;
            dailyGoalsStatsEl.textContent = `Today's Progress â€” New: ${dailyStats.newCardsSeen}/${userGoals.newCards}, Reviews: ${dailyStats.reviewsDone}/${userGoals.reviews}`;
        };

        const showNextCard = () => {
            currentCardEl.style.transition = 'none';
            currentCardEl.classList.remove('is-flipped');
            setTimeout(() => {
                currentCardEl.style.transition = 'transform 0.6s';
            }, 50);

            ratingButtons.classList.add('hidden');
            showAnswerBtn.classList.remove('hidden');
            reviewStartTime = Date.now();
            
            if (sessionQueue.length > 0) {
                currentCard = sessionQueue.shift(); 
            } else if (sessionRepeatPile.length > 0) {
                currentCard = sessionRepeatPile.shift(); 
            } else {
                currentCard = null;
            }

            if (currentCard) {
                cardFrontEl.textContent = currentCard.front;
                cardBackEl.textContent = currentCard.back;
                currentCardEl.classList.remove('hidden');
                noCardsMessage.classList.add('hidden');
                allDoneMessage.classList.add('hidden');
            } else {
                 if (deck.length === 0) {
                    noCardsMessage.classList.remove('hidden');
                } else {
                    allDoneMessage.innerHTML = `<p class="font-semibold text-lg">All done for this session!</p><p>Great work.</p>`;
                    allDoneMessage.classList.remove('hidden');
                }
                currentCardEl.classList.add('hidden');
                showAnswerBtn.classList.add('hidden');
            }
            updateStatsUI();
        };

        const handleShowAnswer = () => {
            currentCardEl.classList.add('is-flipped');
            showAnswerBtn.classList.add('hidden');
            ratingButtons.classList.remove('hidden');
        };

        const handleRating = async (e) => {
            if (!currentCard) return;
            ratingButtons.querySelectorAll('button').forEach(btn => btn.disabled = true);

            try {
                const reviewSpeed = Date.now() - reviewStartTime;
                const rating = e.target.dataset.rating;
                const wasCorrect = rating !== 'again';
                const isNewCard = !currentCard.status || currentCard.status === 'new';
                const cardId = currentCard.id;
                const hasBeenSeenThisSession = sessionSeenCardIds.has(cardId);

                const reviewHistoryRef = collection(db, `artifacts/${appId}/public/data/students/${userLoginId}/reviewHistory`);
                await addDoc(reviewHistoryRef, { cardId: currentCard.id, deckId, timestamp: Date.now(), speed: reviewSpeed, correct: wasCorrect, isNew: isNewCard });

                if (!hasBeenSeenThisSession) {
                    if (isNewCard) {
                        dailyStats.newCardsSeen++;
                    } else {
                        dailyStats.reviewsDone++;
                    }
                    await updateDailyStatsInFirestore();
                    sessionSeenCardIds.add(cardId);
                }
                
                const updates = {};
                updates.status = 'practice';
                updates.deckId = deckId;

                if (rating === 'again' || rating === 'hard') {
                    const cardForRepeat = { ...currentCard, status: 'practice' };
                    sessionRepeatPile.push(cardForRepeat);
                    
                    if (isNewCard) {
                         const progressRef = doc(db, getUserProgressCollectionPath(), cardId);
                         await setDoc(progressRef, updates, { merge: true });
                    }
                } else {
                    const now = new Date();
                    let nextInterval;
                    const currentInterval = currentCard.interval || 1;
                    if (rating === 'good') {
                        nextInterval = isNewCard ? 1 * 24 * 60 : currentInterval * 2.5; // 1 day for new, 2.5x for seen
                    } else { // easy
                        nextInterval = isNewCard ? 4 * 24 * 60 : currentInterval * 4; // 4 days for new, 4x for seen
                    }
                    updates.interval = Math.max(1, parseFloat(nextInterval.toFixed(1)));
                    updates.nextReviewDate = now.getTime() + updates.interval * 60 * 1000;
                    
                    const progressRef = doc(db, getUserProgressCollectionPath(), cardId);
                    await setDoc(progressRef, updates, { merge: true });
                }
            } catch (error) {
                console.error("Error processing rating:", error);
            } finally {
                showNextCard();
                ratingButtons.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
        };
            
        const handleAddCard = async (e) => {
            e.preventDefault();
            const addBtn = e.target.querySelector('button[type="submit"]');
            addBtn.disabled = true;

            const front = frontInput.value.trim(); const back = backInput.value.trim();
            if (!front || !back) {
                addBtn.disabled = false;
                return;
            }
            const newCard = { front, back, nextReviewDate: Date.now(), interval: 1, status: 'new' };
            
            try {
                // User-added cards go to their personal deck AND complete deck
                const personalDeckCollection = collection(db, `artifacts/${appId}/public/data/students/${userLoginId}/decks/personal/cards`);
                await addDoc(personalDeckCollection, newCard);
                
                const completeDeckCollection = collection(db, `artifacts/${appId}/public/data/students/${userLoginId}/decks/complete/cards`);
                await addDoc(completeDeckCollection, newCard);

                frontInput.value = ''; backInput.value = ''; frontInput.focus();
                addCardFeedback.textContent = 'Card added successfully!';
                addCardFeedback.classList.add('text-green-600'); addCardFeedback.classList.remove('text-red-600');
                setTimeout(() => { addCardFeedback.textContent = ''; }, 2000);
            } catch (error) {
                console.error("Error adding card:", error);
                addCardFeedback.textContent = 'Error adding card.';
                addCardFeedback.classList.remove('text-green-600'); addCardFeedback.classList.add('text-red-600');
                setTimeout(() => { addCardFeedback.textContent = ''; }, 2000);
            } finally {
                addBtn.disabled = false;
            }
        };
        
        // --- EDIT DECK FUNCTIONS ---
        const populateCardList = () => {
            cardListContainer.innerHTML = '';
            if (deck.length === 0) {
                cardListContainer.innerHTML = '<p class="p-4 text-center text-gray-500">This deck is empty.</p>';
                return;
            }
            deck.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'p-4 flex justify-between items-center';
                cardEl.innerHTML = `
                    <div class="flex-1 mr-4 overflow-hidden">
                        <p class="font-medium text-gray-800 truncate">${card.front}</p>
                        <p class="text-sm text-gray-500 truncate">${card.back}</p>
                    </div>
                    <div>
                        <button data-id="${card.id}" class="edit-card-btn text-blue-500 hover:text-blue-700 mr-3 font-semibold">Edit</button>
                        <button data-id="${card.id}" class="delete-card-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                    </div>
                `;
                cardListContainer.appendChild(cardEl);
            });
        };
        
        const openEditModal = (cardId) => {
            const card = deck.find(c => c.id === cardId);
            if (!card) return;
            cardIdToEditOrDelete = cardId;
            editFrontInput.value = card.front;
            editBackInput.value = card.back;
            editCardModal.classList.remove('hidden');
        };
        
        const closeEditModal = () => {
            cardIdToEditOrDelete = null;
            editCardModal.classList.add('hidden');
        };

        const handleSaveChanges = async () => {
            saveEditBtn.disabled = true;
            const newFront = editFrontInput.value.trim();
            const newBack = editBackInput.value.trim();

            if (!cardIdToEditOrDelete || !newFront || !newBack) {
                saveEditBtn.disabled = false;
                return;
            };

            const cardRef = doc(db, getMasterDeckCollectionPath(), cardIdToEditOrDelete);
            try {
                await updateDoc(cardRef, { front: newFront, back: newBack });
                closeEditModal();
            } catch (error) {
                console.error("Error updating card:", error);
            } finally {
                saveEditBtn.disabled = false;
            }
        };
        
        const openDeleteConfirm = (cardId) => {
            cardIdToEditOrDelete = cardId;
            deleteConfirmModal.classList.remove('hidden');
        };

        const closeDeleteConfirm = () => {
            cardIdToEditOrDelete = null;
            deleteConfirmModal.classList.add('hidden');
        };

        const handleDeleteCard = async () => {
            if (!cardIdToEditOrDelete) return;
            confirmDeleteBtn.disabled = true;
            const cardRef = doc(db, getMasterDeckCollectionPath(), cardIdToEditOrDelete);
            try {
                await deleteDoc(cardRef);
                closeDeleteConfirm();
            } catch (error) {
                console.error("Error deleting card:", error);
            } finally {
                confirmDeleteBtn.disabled = false;
            }
        };
            
        const switchTab = (tab) => {
            const tabs = {
                review: { section: reviewSection, btn: reviewTabBtn },
                edit: { section: editDeckSection, btn: editTabBtn }
            };

            Object.values(tabs).forEach(({ section, btn }) => {
                section.classList.add('hidden');
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.add('text-gray-500');
            });

            tabs[tab].section.classList.remove('hidden');
            tabs[tab].btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');

            if (tab === 'review') {
                startReviewSession();
            }
            else if (tab === 'edit') {
                 populateCardList();
            }
        };
        
        // --- SETTINGS FUNCTIONS ---
        const openSettingsModal = () => {
            newCardsGoalInput.value = userGoals.newCards;
            reviewsGoalInput.value = userGoals.reviews;
            settingsModal.classList.remove('hidden');
        };

        const closeSettingsModal = () => {
            settingsFeedback.textContent = '';
            settingsModal.classList.add('hidden');
        };

        const handleSaveSettings = async () => {
            saveSettingsBtn.disabled = true;
            const newCards = parseInt(newCardsGoalInput.value, 10);
            const newReviews = parseInt(reviewsGoalInput.value, 10);

            if (isNaN(newCards) || isNaN(newReviews) || newCards < 0 || newReviews < 0) {
                settingsFeedback.textContent = 'Please enter valid numbers.';
                saveSettingsBtn.disabled = false;
                return;
            }

            userGoals = { newCards, reviews: newReviews };
            
            const profileRef = doc(db, `artifacts/${appId}/public/data/students/${userLoginId}/profile/info`);
            try {
                await setDoc(profileRef, { customGoals: userGoals }, { merge: true });
                updateStatsUI();
                closeSettingsModal();
            } catch (error) {
                console.error("Error saving settings:", error);
                settingsFeedback.textContent = 'Could not save settings.';
            } finally {
                saveSettingsBtn.disabled = false;
            }
        };

        // --- TEACHER DASHBOARD FUNCTIONS ---
        const showTeacherDashboard = async () => {
            loginOverlay.classList.add('hidden');
            deckSelectionOverlay.classList.add('hidden');
            appContainer.classList.add('hidden');
            teacherDashboardOverlay.classList.remove('hidden');
            
            studentListContainer.innerHTML = '<p class="text-center text-gray-500">Loading students...</p>';

            const profilesRef = collection(db, `artifacts/${appId}/public/data/student_profiles`);
            const snapshot = await getDocs(profilesRef);

            if (snapshot.empty) {
                studentListContainer.innerHTML = '<p class="text-center text-gray-500">No students have registered yet.</p>';
                return;
            }
            
            studentListContainer.innerHTML = '';
            const students = snapshot.docs.map(doc => doc.data());
            students.forEach(student => {
                const studentEl = document.createElement('div');
                studentEl.className = 'bg-slate-50 p-4 rounded-lg';
                studentEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg text-slate-800">${student.name}</p>
                            <p class="text-sm text-slate-500">${student.studentId}</p>
                        </div>
                        <div class="space-x-2">
                            <button data-id="${student.studentId}" class="view-stats-btn text-blue-500 hover:text-blue-700 font-semibold">View Analytics</button>
                            <button data-id="${student.studentId}" data-name="${student.name}" class="delete-student-btn text-red-500 hover:text-red-700 font-semibold">Delete User</button>
                        </div>
                    </div>
                    <div id="stats-container-${student.studentId}" class="stats-container mt-4 pt-4 border-t border-slate-200">
                        <!-- Per-deck stats will be loaded here -->
                        <p class="text-center text-gray-500">Loading analytics...</p>
                    </div>
                `;
                studentListContainer.appendChild(studentEl);
            });
        };
        
        const toggleStudentStats = async (studentId) => {
            const container = document.getElementById(`stats-container-${studentId}`);
            if (!container) return;

            if(container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                return;
            }
            
            container.classList.add('expanded');
            
            try {
                const historyRef = collection(db, `artifacts/${appId}/public/data/students/${studentId}/reviewHistory`);
                const snapshot = await getDocs(historyRef);
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">No review data found for this student.</p>';
                    return;
                }
                const reviews = snapshot.docs.map(doc => doc.data());

                const deckIds = ['hsk2', 'hsk3', 'hsk4', 'complete'];
                let statsHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

                deckIds.forEach(deckId => {
                    const deckReviews = reviews.filter(r => r.deckId === deckId);
                    const deckName = { hsk2: 'HSK 2', hsk3: 'HSK 3', hsk4: 'HSK 4', complete: 'Complete' }[deckId];

                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                    const weekStart = todayStart - (7 * 24 * 60 * 60 * 1000);
                    const monthStart = todayStart - (30 * 24 * 60 * 60 * 1000);
                    
                    const calculateStats = (reviewArray) => {
                        if (reviewArray.length === 0) return { count: 0, accuracy: '0%', speed: '0s' };
                        const correctCount = reviewArray.filter(r => r.correct).length;
                        const totalSpeed = reviewArray.reduce((sum, r) => sum + r.speed, 0);
                        return {
                            count: reviewArray.length,
                            accuracy: ((correctCount / reviewArray.length) * 100).toFixed(1) + '%',
                            speed: (totalSpeed / reviewArray.length / 1000).toFixed(1) + 's'
                        };
                    };
                    
                    const todayStats = calculateStats(deckReviews.filter(r => r.timestamp >= todayStart));
                    const weekStats = calculateStats(deckReviews.filter(r => r.timestamp >= weekStart));
                    const monthStats = calculateStats(deckReviews.filter(r => r.timestamp >= monthStart));

                    statsHtml += `
                        <div class="bg-white p-3 rounded-md shadow-sm border border-slate-200">
                            <h4 class="font-bold text-blue-700 mb-2">${deckName} Deck</h4>
                            <div class="text-xs space-y-1 text-slate-600">
                                <p><strong>Today:</strong> ${todayStats.count} reviews, ${todayStats.accuracy} acc, ${todayStats.speed} avg.</p>
                                <p><strong>This Week:</strong> ${weekStats.count} reviews, ${weekStats.accuracy} acc, ${weekStats.speed} avg.</p>
                                <p><strong>This Month:</strong> ${monthStats.count} reviews, ${monthStats.accuracy} acc, ${monthStats.speed} avg.</p>
                            </div>
                        </div>
                    `;
                });

                statsHtml += '</div>';
                container.innerHTML = statsHtml;

            } catch (error) {
                console.error("Error fetching student data:", error);
                container.innerHTML = '<p class="text-center text-red-500">Could not load analytics.</p>';
            }
        };

        const hideTeacherDashboard = () => {
            teacherDashboardOverlay.classList.add('hidden');
            loginOverlay.classList.remove('hidden');
        };

        const openDeleteStudentConfirm = (studentId, studentName) => {
            studentToDelete = { id: studentId, name: studentName };
            studentNameToDeleteEl.textContent = `${studentName} (${studentId})`;
            deleteStudentConfirmModal.classList.remove('hidden');
        };

        const closeDeleteStudentConfirm = () => {
            studentToDelete = null;
            deleteStudentConfirmModal.classList.add('hidden');
        };
        
        const deleteStudentData = async () => {
            if (!studentToDelete) return;
            confirmDeleteStudentBtn.disabled = true;
            const { id: studentId } = studentToDelete;
            console.log(`Deleting all data for student: ${studentId}`);
            
            try {
                // Delete user's card progress
                const progressCollectionPath = getUserProgressCollectionPath(studentId);
                const progressSnapshot = await getDocs(collection(db, progressCollectionPath));
                const progressBatch = writeBatch(db);
                progressSnapshot.docs.forEach(doc => progressBatch.delete(doc.ref));
                await progressBatch.commit();
                
                // Delete user's personal decks
                const personalDeckPath = `artifacts/${appId}/public/data/students/${studentId}/decks/personal/cards`;
                const personalDeckSnapshot = await getDocs(collection(db, personalDeckPath));
                const personalDeckBatch = writeBatch(db);
                personalDeckSnapshot.docs.forEach(doc => personalDeckBatch.delete(doc.ref));
                await personalDeckBatch.commit();

                // Delete review history
                const historyCollectionPath = `artifacts/${appId}/public/data/students/${studentId}/reviewHistory`;
                const historySnapshot = await getDocs(collection(db, historyCollectionPath));
                const historyBatch = writeBatch(db);
                historySnapshot.docs.forEach(doc => historyBatch.delete(doc.ref));
                await historyBatch.commit();

                // Delete top-level profile and progress docs
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/students/${studentId}/profile/info`));
                // Delete all daily stat docs
                 const deckIds = ['hsk2', 'hsk3', 'hsk4', 'complete'];
                 for (const deckId of deckIds) {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/students/${studentId}/progress/${deckId}`));
                 }

                // Delete from the student index
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/student_profiles/${studentId}`));

                console.log(`Successfully deleted student ${studentId}`);
                closeDeleteStudentConfirm();
                showTeacherDashboard(); // Refresh the list
            } catch (error) {
                console.error("Error deleting student data:", error);
                alert("An error occurred while deleting the student.");
                closeDeleteStudentConfirm();
            } finally {
                confirmDeleteStudentBtn.disabled = false;
            }
        };

        // --- DECK POPULATION ---
        const populateMasterDecks = async () => {
            const hsk2Data = `
                æˆ‘;wÇ’;I, me
                æˆ‘ä»¬;wÇ’men;we, us
                ä½ ;nÇ;you
                ä½ ä»¬;nÇmen;you (plural)
                ä»–;tÄ;he, him
                å¥¹;tÄ;she, her
                ä»–ä»¬;tÄmen;they (male + female/male)
                å¥¹ä»¬;tÄmen;they (female)
                æ‚¨;nÃ­n;you
                å®ƒ;tÄ;it
                å¤§å®¶;dÃ jiÄ;everyone
                æ¯;mÄ›i;every
                è¿™(è¿™å„¿);zhÃ¨ (zhÃ¨r);here, this
                é‚£(é‚£å„¿);nÃ  (nÃ r);there, that
                å“ªï¼ˆå“ªå„¿ï¼‰;nÇŽ (nÇŽr);where
                è°;shÃ©i;who
                ä»€ä¹ˆ;shÃ©nme;what, why
                å¤šå°‘;duÅshÇŽo;how many, how much
                å‡ ;jÇ;a few, how many
                æ€Žä¹ˆ;zÄ›nme;how
                æ€Žä¹ˆæ ·;zÄ›nmeyÃ ng;how about
                ä¸ºä»€ä¹ˆ;wÃ¨ishÃ©nme;why
                ä¸€;yÄ«;one
                äºŒ;Ã¨r;two
                ä¸‰;sÄn;three
                å››;sÃ¬;four
                äº”;wÇ”;five
                å…­;liÃ¹;six
                ä¸ƒ;qÄ«;seven
                å…«;bÄ;eight
                ä¹;jiÇ”;nine
                å;shÃ­;ten
                é›¶;lÃ­ng;zero
                ä¸¤;liÇŽng;two
                ç™¾;bÇŽi;hundred
                åƒ;qiÄn;thousand
                ç¬¬ä¸€;dÃ¬yÄ«;first
                ä¸ª;gÃ¨;one, a, an
                å²;suÃ¬;year
                æœ¬;bÄ›n;volume
                äº›;xiÄ“;some
                å—;kuÃ i;piece
                æ¬¡;cÃ¬;number
                å…¬æ–¤;gÅngjÄ«n;kilogram
                å…ƒ;yuÃ¡n;yuan
                ä»¶;jiÃ n;piece
                å¼ ;zhÄng;sheet
                ä¸;bÃ¹;no
                æ²¡;mÃ©i;no
                å¾ˆ;hÄ›n;quite, very
                å¤ª;tÃ i;too
                éƒ½;dÅu;all
                åˆ«;biÃ©;other
                éžå¸¸;fÄ“ichÃ¡ng;very
                ä¹Ÿ;yÄ›;likewise
                è¿˜;hÃ¡i;repay
                æœ€;zuÃ¬;most
                çœŸ;zhÄ“n;real
                æ­£åœ¨;zhÃ¨ngzÃ i;be being
                å·²ç»;yÇjÄ«ng;already
                ä¸€èµ·;yÃ¬qÇ;together
                å†;zÃ i;again
                å°±;jiÇœ;at once
                å’Œ;hÃ©;and
                å› ä¸º;yÄ«nwÃ¨i;because
                æ‰€ä»¥;suÇ’yÇ;so
                ä½†æ˜¯;dÃ nshÃ¬;but
                åœ¨;zÃ i;in, at
                ä»Ž;cÃ³ng;from
                å¯¹;duÃ¬;right
                æ­¤;cÇ;this
                å‘;xiÃ ng;towards
                ç¦»;lÃ­;leave
                å–‚;wÃ¨i;hello
                å®¶;jiÄ;home
                å­¦æ ¡;xuÃ©xiÃ o;school
                é¥­é¦†;fÃ n guÇŽn;restaurant
                å•†åº—;shÄngdiÃ n;store
                åŒ»é™¢;yÄ«yuÃ n;hospital
                ç«è½¦ç«™;huÇ’chÄ“zhÃ n;train station
                ä¸­å›½;zhÅngguÃ³;China
                æ©Ÿå ´;jÄ«chÇŽng;airport
                æ•™å®¤;jiÃ oshÃ¬;classroom
                æˆ¿é—´;fÃ¡ngjiÄn;room
                è·¯;lÃ¹;road
                åŒ—äº¬;bÄ›ijÄ«ng;Beijing
                ä¸Š;shÃ ng;up
                ä¸‹;xiÃ ;below
                å‰é¢;qiÃ¡nmiÃ n;front
                åŽé¢;hÃ²umiÃ n;behind
                å·¦è¾¹;zuÇ’biÄn;left
                å³è¾¹;yÃ²ubiÄn;right
                å¤–;wÃ i;out
                æ—è¾¹;pÃ¡ngbiÄn;side
                é‡Œé¢;lÇmiÃ n;inside
                ä»Šå¤©;jÄ«ntiÄn;today
                æ˜Žå¤©;mÃ­ngtiÄn;tomorrow
                æ˜¨å¤©;zuÃ³tiÄn;yesterday
                ä¸Šåˆ;shÃ ngwÇ”;morning
                ä¸­åˆ;zhÅngwÇ”;noon
                ä¸‹åˆ;xiÃ wÇ”;afternoon
                å¹´;niÃ¡n;year
                æœˆ;yuÃ¨;month
                æ—¥;rÃ¬;day
                æ˜ŸæœŸ;xÄ«ngqÄ«;week
                ç‚¹;diÇŽn;dot, spot
                åˆ†é’Ÿ;fÄ“nzhÅng;minute
                çŽ°åœ¨;xiÃ nzÃ i;now
                æ—¶å€™;shÃ­hÃ³u;time
                æ—©ä¸Š;zÇŽoshÃ ng;morning
                æ™šä¸Š;wÇŽnshÃ ng;night
                å°æ—¶;xiÇŽoshÃ­;hour
                æ—¶é—´;shÃ­jiÄn;time
                åŽ»å¹´;qÃ¹niÃ¡n;last year
                å·;hÃ o;number
                ç”Ÿæ—¥;shÄ“ngrÃ¬;birthday
                çˆ¸çˆ¸;bÃ ba;father
                å¦ˆå¦ˆ;mÄma;mother
                å„¿å­;Ã©rzi;son
                å¥³å„¿;nÇšÃ©r;daughter
                è€å¸ˆ;lÇŽoshÄ«;teacher
                å­¦ç”Ÿ;xuÃ©shÄ“ng;student
                åŒå­¦;tÃ³ngxuÃ©;shoolmate
                æœ‹å‹;pÃ©ngyÇ’u;friend
                åŒ»ç”Ÿ;yÄ«shÄ“ng;doctor
                å…ˆç”Ÿ;xiÄnshÄ“ng;sir
                å°å§;xiÇŽojiÄ›;Miss
                å“¥å“¥;gÄ“ge;brother
                å§å§;jiÄ›jie;sister
                å¼Ÿå¼Ÿ;dÃ¬di;younger brother
                å¦¹å¦¹;mÃ¨imei;sis
                ä¸ˆå¤«;zhÃ ngfu;husband
                å¦»å­;qÄ«zi;wife
                å­©å­;hÃ¡izi;child
                ç”·äºº;nÃ¡nrÃ©n;man
                å¥³äºº;nÇšrÃ©n;woman
                æœåŠ¡å‘˜;fÃºwÃ¹yuÃ¡n;waiter
                è¡£æœ;yÄ«fu;cloth
                æ°´;shuÇ;water
                èœ;cÃ i;vegetable
                ç±³é¥­;mÇfÃ n;rice
                æ°´æžœ;shuÇguÇ’;fruit
                è‹¹æžœ;pÃ­ngguÇ’;apple
                èŒ¶;chÃ¡;tea
                æ¯å­;bÄ“izi;cup
                é’±;qiÃ¡n;money
                é£žæœº;fÄ“ijÄ«;airplane
                å‡ºç§Ÿè½¦;chÅ«zÅ«chÄ“;taxi
                ç”µè§†;diÃ nshÃ¬;television
                ç”µè„‘;diÃ nnÇŽo;computer
                ç”µå½±;diÃ nyÇng;movie
                å¤©æ°”;tiÄnqÃ¬;weather
                çŒ«;mÄo;cat
                ç‹—;gÇ’u;dog
                ä¸œè¥¿;dÅngxÄ«;thing
                é±¼;yÃº;fish
                ç¾Šè‚‰;yÃ¡ngrÃ²u;mutton
                ç‰›å¥¶;niÃºnÇŽi;milk
                é¸¡è›‹;jÄ«dÃ n;egg
                è¥¿ç“œ;xÄ«guÄ;watermelon
                å’–å•¡;kÄfÄ“i;coffee
                è‡ªè¡Œè½¦;zÃ¬xÃ­ngchÄ“;bike
                èˆ¹;chuÃ¡n;boat
                é›ª;xuÃ©;snow
                è¯;yÃ o;medicine
                æ‰‹æœº;shÇ’ujÄ«;phone
                æ‰‹è¡¨;shÇ’ubiÇŽo;watch
                çœ¼ç›;yÇŽnjÄ«ng;eye
                èº«ä½“;shÄ“ntÇ;body
                å…¬å…±æ±½è½¦;gÅnggÃ²ngqÃ¬chÄ“;bus
                æŠ¥çº¸;bÃ ozhÇ;newspaper
                äºº;rÃ©n;person
                åå­—;mÃ­ngzi;name
                ä¹¦;shÅ«;book
                æ±‰è¯­;hÃ nyÇ”;Chinese
                å­—;zÃ¬;character
                æ¡Œå­;zhuÅzi;desk
                æ¤…å­;yÇzi;chair
                é—¨;mÃ©n;door
                é¢˜;tÃ­;topic
                è¯¾;kÃ¨;lesson
                å§“;xÃ¬ng;surname
                é—®é¢˜;wÃ¨ntÃ­;question
                äº‹æƒ…;shÃ¬qing;matter
                è€ƒè¯•;kÇŽoshÃ¬;exam
                ç¥¨;piÃ o;ticket
                æ„æ€;yÃ¬si;meaning
                é¢œè‰²;yÃ¡nsÃ¨;color
                è°¢è°¢;xiÃ¨xiÃ¨;thank
                ä¸å®¢æ°”;bÃºkÃ¨qÃ¬;you are welcome
                å†è§;zÃ ijiÃ n;good-bye
                è¯·;qÇng;please
                å¯¹ä¸èµ·;duÃ¬bÃ¹qÇ;sorry
                æ²¡å…³ç³»;mÃ©iguÄnxÃ¬;It doesn't matter
                æ¬¢è¿Ž;huÄnyÃ­ng;welcome
                æ˜¯;shÃ¬;am, is, are
                æœ‰;yÇ’u;have
                çœ‹;kÃ n;look
                å¬;tÄ«ng;listen
                è¯´è¯;shuÅhuÃ ;speak
                è¯»;dÃº;read
                å†™;xiÄ›;write
                çœ‹è§;kÃ njiÃ n;see
                å«;jiÃ o;call
                æ¥;lÃ¡i;come
                å›ž;huÃ­;return
                åŽ»;qÃ¹;go
                åƒ;chÄ«;eat
                å–;hÄ“;drink
                ç¡è§‰;shuÃ¬jiÃ o;sleep
                æ‰“ç”µè¯;dÇŽdiÃ nhuÃ ;call up
                åš;zuÃ²;do
                ä¹°;mÇŽi;buy
                å¼€;kÄi;open
                å;zuÃ²;sit
                ä½;zhÃ¹;live
                å­¦ä¹ ;xuÃ©xÃ­;study
                å·¥ä½œ;gÅngzuÃ²;work
                ä¸‹é›¨;xiÃ yÇ”;rain
                é—®;wÃ¨n;ask
                èµ°;zÇ’u;walk
                è¿›;jÃ¬n;enter
                å‡º;chÅ«;come
                è·‘æ­¥;pÇŽobÃ¹;run
                åˆ°;dÃ o;arrive
                ç©¿;chuÄn;wear
                æ´—;xÇ;wash
                ç»™;gÄ›i;give
                æ‰¾;zhÇŽo;find
                æ‡‚;dÇ’ng;understand
                ç¬‘;xiÃ o;smile
                å›žç­”;huÃ­dÃ¡;answer
                å‘Šè¯‰;gÃ osÃ¹;tell
                å‡†å¤‡;zhÇ”nbÃ¨i;prepare
                å¼€å§‹;kÄishÇ;begin
                ä»‹ç»;jiÃ¨shÃ o;introduce
                å¸®åŠ©;bÄngzhÃ¹;help
                çŽ©;wÃ¡n;play
                é€;sÃ²ng;present
                ç­‰;dÄ›ng;wait
                è®©;rÃ ng;let
                èµ·åºŠ;qÇchuÃ¡ng;get up
                å”±æ­Œ;chÃ nggÄ“;sing
                è·³èˆž;tiÃ owÇ”;dance
                æ—…æ¸¸;lÇšyÃ³u;travel
                ä¸Šç­;shÃ ngbÄn;be on duty
                ç”Ÿç—…;shÄ“ngbÃ¬ng;fall ill
                ä¼‘æ¯;xiÅ«xi;rest
                è¿åŠ¨;yÃ¹ndÃ²ng;exercise
                æ¸¸æ³³;yÃ³uyÇ’ng;swim
                è¸¢è¶³çƒ;tÄ«zÃºqiÃº;play footbal
                æ‰“ç¯®çƒ;dÇŽlÃ¡nqiÃº;play basketball
                å®Œ;wÃ¡n;finish
                çˆ±;Ã i;love
                å–œæ¬¢;xÇhuÄn;love, like
                æƒ³;xiÇŽng;want
                è®¤è¯†;rÃ¨nshi;know
                è§‰å¾—;juÃ©dÃ©;think
                çŸ¥é“;zhÄ«dÃ o;know
                å¸Œæœ›;xÄ«wÃ ng;hope
                ä¼š;huÃ¬;can
                èƒ½;nÃ©ng;can, be able
                å¯ä»¥;kÄ›yÇ;can
                è¦;yÃ o;ask for
                å¯èƒ½;kÄ›nÃ©ng;may
                å¥½;hÇŽo;good
                å¤§;dÃ ;big
                å°;xiÇŽo;small
                å¤š;duÅ;many, much
                å°‘;shÇŽo;few, little
                å†·;lÄ›ng;cold
                çƒ­;rÃ¨;hot
                é«˜å…´;gÄoxÃ¬ng;happy
                æ¼‚äº®;piÃ oliÃ ng;beautiful
                é«˜;gÄo;tall
                çº¢;hÃ³ng;red
                ç™½;bÃ¡i;white
                é»‘;hÄ“i;black
                å¿™;mÃ¡ng;busy
                å¿«;kuÃ i;fast
                æ…¢;mÃ n;slow
                è¿œ;yuÇŽn;far
                è¿‘;jÃ¬n;close
                å¥½åƒ;hÇŽochÄ«;delicious
                ç´¯;lÃ¨i;tired
                é•¿;chÃ¡ng;long
                æ–°;xÄ«n;new
                è´µ;guÃ¬;expensive
                ä¾¿å®œ;piÃ¡nyi;cheap
                æ™´;qÃ­ng;fine
                é˜´;yÄ«n;cloudy
                é”™;cuÃ²;wrong
                å¿«ä¹;kuÃ ilÃ¨;happy
            `;

            const hsk3Data = `
                é˜¿å§¨;ÄyÃ­;aunt
                å•Š;a;ah
                çŸ®;ÇŽi;short
                çˆ±å¥½;Ã ihÃ o;hobby
                å®‰é™;ÄnjÃ¬ng;Be quiet
                æŠŠ;bÇŽ;hold
                ç­;bÄn;class
                æ¬;bÄn;turn; pull
                åŠ;bÃ n;half
                åŠžæ³•;bÃ nfÇŽ;Way
                åŠžå…¬å®¤;bÃ ngÅngshÃ¬;Office
                å¸®å¿™;bÄngmÃ¡ng;Help
                åŒ…;bÄo;package
                é¥±;bÇŽo;full
                åŒ—æ–¹;bÄ›ifÄng;north
                è¢«;bÃ¨i;cover
                é¼»å­;bÃ­zi;nose
                æ¯”;bÇ;than
                æ¯”è¾ƒ;bÇjiÃ o;compare
                æ¯”èµ›;bÇsÃ i;Match
                å¿…é¡»;bÃ¬xÅ«;Must
                å˜åŒ–;biÃ nhÃ ;change
                è¡¨ç¤º;biÇŽoshÃ¬;Express
                è¡¨æ¼”;biÇŽoyÇŽn;perform
                åˆ«äºº;biÃ©ren;Others
                å®¾é¦†;bÄ«nguÇŽn;hotel
                å†°ç®±;bÄ«ngxiÄng;Refrigerator
                æ‰;cÃ¡i;just
                èœå•;cÃ idÄn;menu
                å‚åŠ ;cÄnjiÄ;participate in
                è‰;cÇŽo;grass
                å±‚;cÃ©ng;layer
                å·®;chÃ ;difference
                è¶…å¸‚;chÄoshÃ¬;Supermarket
                è¡¬è¡«;chÃ¨nshÄn;shirt
                æˆç»©;chÃ©ngjÃ¬;achievement
                åŸŽå¸‚;chÃ©ngshÃ¬;City
                è¿Ÿåˆ°;chÃ­dÃ o;Late
                å‡ºçŽ°;chÅ«xiÃ n;Appear
                åŽ¨æˆ¿;chÃºfÃ¡ng;Kitchen
                é™¤äº†;chÃºle;except
                æ˜¥;chÅ«n;spring
                è¯è¯­;cÃ­yÇ”;terms
                èªæ˜Ž;cÅngming;clever
                æ‰“æ‰«;dÇŽsÇŽo;Clean
                æ‰“ç®—;dÇŽsuÃ n;Plan
                å¸¦;dÃ i;belt
                æ‹…å¿ƒ;dÄnxÄ«n;Worry
                è›‹ç³•;dÃ ngÄo;Cake
                å½“ç„¶;dÄngrÃ¡n;Of course
                ç¯;dÄ“ng;lamp
                ä½Ž;dÄ«;low
                åœ°æ–¹;dÃ¬fang;local
                åœ°é“;dÃ¬tiÄ›;metro
                åœ°å›¾;dÃ¬tÃº;Map
                ç”µæ¢¯;diÃ ntÄ«;Elevator
                ç”µå­é‚®ä»¶;diÃ nzÇyÃ³ujiÃ n;E-mail
                ä¸œ;dÅng;east
                å†¬;dÅng;winter
                åŠ¨ç‰©;dÃ²ngwÃ¹;Animal
                çŸ­;duÇŽn;short
                æ®µ;duÃ n;paragraph
                é”»ç‚¼;duÃ nliÃ n;Physical exercise
                å¤šä¹ˆ;duÅme;what
                é¥¿;Ã¨;hungry
                è€Œä¸”;Ã©rqiÄ›;And
                è€³æœµ;Ä›rduo;Ears
                å‘çƒ§;fÄshÄo;Have a fever
                å‘çŽ°;fÄxiÃ n;find
                æ–¹ä¾¿;fÄngbiÃ n;convenient
                æ”¾;fÃ ng;discharge
                æ”¾å¿ƒ;fÃ ngxÄ«n;Don't worry
                åˆ†;fÄ“n;branch
                é™„è¿‘;fÃ¹jÃ¬n;nearby
                å¤ä¹ ;fÃ¹xÃ­;Review
                å¹²å‡€;gÄnjÃ¬ng;clean
                æ•¢;gÇŽn;dare
                æ„Ÿå†’;gÇŽnmÃ o;Cold
                åˆšæ‰;gÄngcÃ¡i;just
                æ ¹æ®;gÄ“njÃ¹;according to
                è·Ÿ;gÄ“n;with
                æ›´;gÃ¨ng;more
                å…¬å¸;gÅngsÄ«;company
                å…¬å›­;gÅngyuÃ¡n;Park
                æ•…äº‹;gÃ¹shi;Story
                åˆ®é£Ž;guÄfÄ“ng;Windy
                å…³;guÄn;shut
                å…³ç³»;guÄnxÃ¬;relationship
                å…³å¿ƒ;guÄnxÄ«n;Care for
                å…³äºŽ;guÄnyÃº;about
                å›½å®¶;guÃ³jiÄ;Country
                æžœæ±;guÇ’zhÄ«;fruit juice
                è¿‡åŽ»;guÃ²qÃ¹;Past times
                è¿˜æ˜¯;hÃ¡ishÃ¬;still
                å®³æ€•;hÃ ipÃ ;Fear
                é»‘æ¿;hÄ“ibÇŽn;blackboard
                åŽæ¥;hÃ²ulÃ¡i;later
                æŠ¤ç…§;hÃ¹zhÃ o;passport
                èŠ±;huÄ;Flower
                èŠ±å›­;huÄyuÃ¡n;Garden
                ç”»;huÃ ;painting
                å;huÃ i;bad
                è¿˜;huÃ¡n;still
                çŽ¯å¢ƒ;huÃ¡njÃ¬ng;Environmental Science
                æ¢;huÃ n;change
                é»„;huÃ¡ng;yellow
                ä¼šè®®;huÃ¬yÃ¬;Meeting
                æˆ–è€…;huÃ²zhÄ›;perhaps
                å‡ ä¹Ž;jÄ«hÅ«;almost
                æœºä¼š;jÄ«huÃ¬;Opportunity
                æž;jÃ­;extremely
                è®°å¾—;jÃ¬de;remember
                å­£èŠ‚;jÃ¬jiÃ©;Season
                æ£€æŸ¥;jiÇŽnchÃ¡;inspect
                ç®€å•;jiÇŽndÄn;simple
                å¥åº·;jiÃ nkÄng;Healthy
                è§é¢;jiÃ nmiÃ n;meet
                è®²;jiÇŽng;speak
                æ•™;jiÄo;teach
                è§’;jiÇŽo;horn
                è„š;jiÇŽo;foot
                æŽ¥;jiÄ“;meet
                è¡—é“;jiÄ“dÃ o;Street
                ç»“å©š;jiÃ©hÅ«n;marry
                ç»“æŸ;jiÃ©shÃ¹;End
                èŠ‚ç›®;jiÃ©mÃ¹;program
                èŠ‚æ—¥;jiÃ©rÃ¬;festival
                è§£å†³;jiÄ›juÃ©;Solve
                å€Ÿ;jiÃ¨;borrow
                ç»å¸¸;jÄ«ngchÃ¡ng;Often
                ç»è¿‡;jÄ«ngguÃ²;after
                ç»ç†;jÄ«nglÇ;manager
                ä¹…;jiÇ”;long
                æ—§;jiÃ¹;used
                ä¸¾è¡Œ;jÇ”xÃ­ng;hold
                å¥å­;jÃ¹zi;sentence
                å†³å®š;juÃ©dÃ¬ng;Decision
                æ¸´;kÄ›;thirsty
                å¯çˆ±;kÄ›'Ã i;Lovely
                åˆ»;kÃ¨;moment
                å®¢äºº;kÃ¨rÃ©n;Guest
                ç©ºè°ƒ;kÅngtiÃ¡o;Air conditioner
                å£;kÇ’u;mouth
                å“­;kÅ«;cry
                è£¤å­;kÃ¹zi;trousers
                ç­·å­;kuÃ izi;chopsticks
                è“;lÃ¡n;blue
                è€;lÇŽo;old
                ç¦»å¼€;lÃ­kÄi;leave
                ç¤¼ç‰©;lÇwÃ¹;gift
                åŽ†å²;lÃ¬shÇ;History
                è„¸;liÇŽn;face
                ç»ƒä¹ ;liÃ nxÃ­;Practice
                è¾†;liÃ ng;Car
                äº†è§£;liÇŽojiÄ›;understand
                é‚»å±…;lÃ­njÅ«;neighbor
                æ¥¼;lÃ³u;floor
                ç»¿;lÇœ;green
                é©¬;mÇŽ;Horse
                é©¬ä¸Š;mÇŽshÃ ng;Right off
                å–;mÃ i;sell
                æ»¡æ„;mÇŽnyÃ¬;Satisfied
                å¸½å­;mÃ ozi;Hat
                ç±³;mÇ;rice
                é¢åŒ…;miÃ nbÄo;Bread
                é¢æ¡;miÃ ntiÃ¡o;noodle
                æ˜Žç™½;mÃ­ngbai;clear
                æ‹¿;nÃ¡;take
                å¥¶å¥¶;nÇŽinai;grandma
                å—;nÃ¡n;south
                éš¾;nÃ¡n;disaster; blame
                éš¾è¿‡;nÃ¡nguÃ²;Sorry
                å¹´çº§;niÃ¡njÃ­;grade
                å¹´è½»;niÃ¡nqÄ«ng;Young
                é¸Ÿ;niÇŽo;bird
                åŠªåŠ›;nÇ”lÃ¬;Strive
                çˆ¬å±±;pÃ¡shÄn;Mountain climbing
                ç›˜å­;pÃ¡nzi;plate
                èƒ–;pÃ ng;fat
                å•¤é…’;pÃ­jiÇ”;Beer
                è‘¡è„;pÃºtao;Grape
                æ™®é€šè¯;pÇ”tÅnghuÃ ;Mandarin
                å…¶å®ž;qÃ­shÃ­;actually
                å…¶ä»–;qÃ­tÄ;Other
                éª‘;qÃ­;ride
                å¥‡æ€ª;qÃ­guÃ i;strange
                é“…ç¬”;qiÄnbÇ;pencil
                æ¸…æ¥š;qÄ«ngchu;clear
                ç§‹;qiÅ«;autumn
                è£™å­;qÃºnzi;skirt
                ç„¶åŽ;rÃ¡nhÃ²u;Then
                çƒ­æƒ…;rÃ¨qÃ­ng;Enthusiasm
                è®¤ä¸º;rÃ¨nwÃ©i;think
                è®¤çœŸ;rÃ¨nzhÄ“n;earnest
                å®¹æ˜“;rÃ³ngyÃ¬;easily
                å¦‚æžœ;rÃºguÇ’;If
                ä¼ž;sÇŽn;umbrella
                ä¸Šç½‘;shÃ ngwÇŽng;Surf the Internet
                ç”Ÿæ°”;shÄ“ngqÃ¬;get angry
                å£°éŸ³;shÄ“ngyÄ«n;voice
                ä½¿;shÇ;send
                ä¸–ç•Œ;shÃ¬jiÃ¨;world
                ç˜¦;shÃ²u;thin
                èˆ’æœ;shÅ«fu;comfortable
                å”å”;shÅ«shu;uncle
                æ ‘;shÃ¹;tree
                æ•°å­¦;shÃ¹xuÃ©;Mathematics
                åˆ·ç‰™;shuÄyÃ¡;Brush one's teeth
                åŒ;shuÄng;double
                æ°´å¹³;shuÇpÃ­ng;level
                å¸æœº;sÄ«jÄ«;Driver
                è™½ç„¶;suÄ«rÃ¡n;although
                å¤ªé˜³;tÃ iyÃ¡ng;sunlight
                ç³–;tÃ¡ng;sugar
                ç‰¹åˆ«;tÃ¨biÃ©;Especially
                ç–¼;tÃ©ng;They hurt
                æé«˜;tÃ­gÄo;increase
                ä½“è‚²;tÇyÃ¹;Sports
                ç”œ;tiÃ¡n;sweet
                æ¡;tiÃ¡o;strip
                åŒäº‹;tÃ³ngshÃ¬;Colleague
                åŒæ„;tÃ³ngyÃ¬;Agree
                å¤´å‘;tÃ³ufa;Hair
                çªç„¶;tÅ«rÃ¡n;suddenly
                å›¾ä¹¦é¦†;tÃºshÅ«guÇŽn;Library
                è…¿;tuÇ;leg
                å®Œæˆ;wÃ¡nchÃ©ng;complete
                ç¢—;wÇŽn;bowl
                ä¸‡;wÃ n;ten thousand
                å¿˜è®°;wÃ ngjÃ¬;forget
                ä¸º;wÃ¨i;by
                ä¸ºäº†;wÃ¨ile;in order to
                ä½;wÃ¨i;position
                æ–‡åŒ–;wÃ©nhuÃ ;Culture
                è¥¿;xÄ«;west
                ä¹ æƒ¯;xÃ­guÃ n;Habit
                æ´—æ‰‹é—´;xÇshÇ’ujiÄn;Restroom
                æ´—æ¾¡;xÇzÇŽo;Take a shower
                å¤;xiÃ ;summer
                å…ˆ;xiÄn;before
                é¦™è•‰;xiÄngjiÄo;Banana
                ç›¸åŒ;xiÄngtÃ³ng;identical
                ç›¸ä¿¡;xiÄngxÃ¬n;believe
                åƒ;xiÃ ng;image
                å°å¿ƒ;xiÇŽoxÄ«n;Look out
                æ ¡é•¿;xiÃ ozhÇŽng;Principal
                éž‹;xiÃ©;shoes
                æ–°é—»;xÄ«nwÃ©n;Journalism
                æ–°é²œ;xÄ«nxiÄn;fresh
                ä¿¡;xÃ¬n;letter
                è¡ŒæŽç®±;xÃ­nglixiÄng;Trunk
                å…´è¶£;xÃ¬ngqÃ¹;Interest
                ç†ŠçŒ«;xiÃ³ngmÄo;Panda
                éœ€è¦;xÅ«yÃ o;Need
                é€‰æ‹©;xuÇŽnzÃ©;Choice
                è¦æ±‚;yÄoqiÃº;Requirement
                çˆ·çˆ·;yÃ©ye;grandpa
                ä¸€å®š;yÃ­dÃ¬ng;Certain
                ä¸€å…±;yÃ­gÃ²ng;Altogether
                ä¸€ä¼šå„¿;yÃ­huÃ¬r;A little while
                ä¸€æ ·;yÃ­yÃ ng;equally
                ä»¥åŽ;yÇhÃ²u;In the future
                ä»¥å‰;yÇqiÃ¡n;before
                ä»¥ä¸º;yÇwÃ©i;Think
                ä¸€èˆ¬;yÃ¬bÄn;commonly
                ä¸€è¾¹;yÃ¬biÄn;One side
                ä¸€ç›´;yÃ¬zhÃ­;always
                é˜´;yÄ«n;Yin
                éŸ³ä¹;yÄ«nyuÃ¨;Music
                é“¶è¡Œ;yÃ­nhÃ¡ng;Bank
                åº”è¯¥;yÄ«nggÄi;Should
                å½±å“;yÇngxiÇŽng;Influence
                ç”¨;yÃ²ng;use
                æ¸¸æˆ;yÃ³uxÃ¬;Game
                æœ‰å;yÇ’umÃ­ng;Famous
                åˆ;yÃ²u;also
                é‡åˆ°;yÃ¹dÃ o;encounter
                æ„¿æ„;yuÃ nyÃ¬;Be willing
                æœˆäº®;yuÃ¨liang;Moon
                è¶Š;yuÃ¨;The more
                äº‘;yÃºn;cloud
                ç«™;zhÃ n;station
                é•¿;zhÇŽng;long
                ç€æ€¥;zhÃ¡ojÃ­;Worry
                ç…§é¡¾;zhÃ ogÃ¹;look after
                ç…§ç‰‡;zhÃ opiÃ n;Photo
                ç…§ç›¸æœº;zhÃ oxiÃ ngjÄ«;Camera
                åª;zhÇ;only
                ä¸­é—´;zhÅngjiÄn;Middle
                ç»ˆäºŽ;zhÅngyÃº;finally
                ç§;zhÇ’ng;species
                é‡è¦;zhÃ²ngyÃ o;important
                å‘¨æœ«;zhÅumÃ²;Weekend
                ä¸»è¦;zhÇ”yÃ o;main
                ç¥;zhÃ¹;wish
                æ³¨æ„;zhÃ¹yÃ¬;Be careful
                å­—å…¸;zÃ¬diÇŽn;Dictionaries
                è‡ªå·±;zÃ¬jÇ;Own
                æ€»æ˜¯;zÇ’ngshÃ¬;always
                æœ€è¿‘;zuÃ¬jÃ¬n;Lately
                ä½œä¸š;zuÃ²yÃ¨;homework
                ä½œç”¨;zuÃ²yÃ²ng;Effect
            `;
            
            const vocabList = (dataString) => {
                return dataString.trim().split('\n').map(line => {
                    const parts = line.split(';');
                    if (parts.length < 3) return null;
                    const [front, pinyin, english] = parts;
                    return { front: front.trim(), back: `${pinyin.trim()} - ${english.trim()}` };
                }).filter(Boolean);
            };

            const hsk2Cards = vocabList(hsk2Data);
            const hsk3Cards = vocabList(hsk3Data);

            const addCardsToBatch = async (cards, deckName, updateProgress) => {
                const collectionRef = collection(db, getMasterDeckCollectionPath(deckName));
                const batchSize = 100;
                for (let i = 0; i < cards.length; i += batchSize) {
                    const batch = writeBatch(db);
                    const chunk = cards.slice(i, i + batchSize);
                    chunk.forEach(word => {
                        const newCard = { front: word.front, back: word.back };
                        const cardRef = doc(collectionRef);
                        batch.set(cardRef, newCard);
                    });
                    await batch.commit();
                    if(updateProgress) updateProgress(chunk.length);
                }
            };
            
            let totalCards = hsk2Cards.length + hsk3Cards.length;
            let cardsLoaded = 0;
            const updateProgress = (batchSize) => {
                cardsLoaded += batchSize;
                loginError.textContent = `Building master decks... ${cardsLoaded}/${totalCards}`;
            };
            
            await addCardsToBatch(hsk2Cards, 'hsk2', updateProgress);
            await addCardsToBatch(hsk3Cards, 'hsk3', updateProgress);
            await addCardsToBatch([...hsk2Cards, ...hsk3Cards], 'complete');
            
            console.log('Master decks populated');
        };

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        deckButtons.addEventListener('click', (e) => {
            if (e.target.classList.contains('deck-btn')) handleDeckSelection(e.target.dataset.deck);
        });
        changeDeckBtn.addEventListener('click', handleChangeDeck);
        reviewTabBtn.addEventListener('click', () => switchTab('review'));
        editTabBtn.addEventListener('click', () => switchTab('edit'));
        showAnswerBtn.addEventListener('click', handleShowAnswer);
        ratingButtons.addEventListener('click', (e) => {
            if (e.target.classList.contains('rating-btn')) handleRating(e);
        });
        addCardForm.addEventListener('submit', handleAddCard);
        
        // Add Card Modal Listeners
        openAddCardModalBtn.addEventListener('click', () => addCardModal.classList.remove('hidden'));
        cancelAddBtn.addEventListener('click', () => addCardModal.classList.add('hidden'));

        // Edit/Delete Listeners
        cardListContainer.addEventListener('click', (e) => {
            const target = e.target;
            if(target.classList.contains('edit-card-btn')) {
                openEditModal(target.dataset.id);
            } else if (target.classList.contains('delete-card-btn')) {
                openDeleteConfirm(target.dataset.id);
            }
        });
        cancelEditBtn.addEventListener('click', closeEditModal);
        saveEditBtn.addEventListener('click', handleSaveChanges);
        cancelDeleteBtn.addEventListener('click', closeDeleteConfirm);
        confirmDeleteBtn.addEventListener('click', handleDeleteCard);
        
        // Help Modal Listeners
        helpIcon.addEventListener('click', () => helpModal.classList.remove('hidden'));
        closeHelpBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) helpModal.classList.add('hidden');
        });

        // Settings Modal Listeners
        openSettingsBtn.addEventListener('click', openSettingsModal);
        cancelSettingsBtn.addEventListener('click', closeSettingsModal);
        saveSettingsBtn.addEventListener('click', handleSaveSettings);

        // Teacher Listeners
        teacherAdminLink.addEventListener('click', () => {
            loginOverlay.classList.add('hidden');
            teacherCodeOverlay.classList.remove('hidden');
        });
        
        backFromCodeBtn.addEventListener('click', () => {
            teacherCodeError.textContent = '';
            teacherCodeInput.value = '';
            teacherCodeOverlay.classList.add('hidden');
            loginOverlay.classList.remove('hidden');
        });

        submitTeacherCodeBtn.addEventListener('click', () => {
            const enteredCode = teacherCodeInput.value.trim();
            if (enteredCode === 'WynR29') {
                teacherCodeError.textContent = '';
                teacherCodeInput.value = '';
                teacherCodeOverlay.classList.add('hidden');
                showTeacherDashboard();
            } else {
                teacherCodeError.textContent = 'Incorrect class code.';
            }
        });

        backToLoginScreenBtn.addEventListener('click', hideTeacherDashboard);
        
        studentListContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            const studentId = target.dataset.id;
            const studentName = target.dataset.name;
            
            if(target.classList.contains('view-stats-btn')) {
                toggleStudentStats(studentId);
            } else if (target.classList.contains('delete-student-btn')) {
                openDeleteStudentConfirm(studentId, studentName);
            }
        });
        
        cancelDeleteStudentBtn.addEventListener('click', closeDeleteStudentConfirm);
        confirmDeleteStudentBtn.addEventListener('click', deleteStudentData);

        // --- INITIALIZATION ---
        (async () => {
            await initializeFirebase();
        })();
    </script>
</body>
</html>

