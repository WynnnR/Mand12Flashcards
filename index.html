<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. Zhang's Mandarin 12 Flashcard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card-container {
            perspective: 1000px;
        }
        .card {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 1rem;
        }
        .card-face-back {
            transform: rotateY(180deg);
        }
        #login-overlay, #deck-selection-overlay, #teacher-dashboard-overlay, #teacher-code-overlay, #edit-card-modal, #delete-confirm-modal, #help-modal, #delete-student-confirm-modal, #add-card-modal, #settings-modal {
            z-index: 10;
        }
        .stats-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .stats-container.expanded {
            max-height: 1000px; /* Adjust as needed */
        }
        /* Spinner for loading state */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <!-- Login Screen -->
    <div id="login-overlay" class="absolute inset-0 bg-slate-100 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-lg text-center max-w-sm w-full relative">
            <h2 class="text-2xl font-bold text-blue-600 mb-2">Student Login</h2>
            <p class="text-gray-600 mb-6">Enter your Name and Student ID to begin.</p>
            <div class="space-y-3">
                <input id="student-name-input" type="text" placeholder="Your Full Name..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <input id="student-id-input" type="text" placeholder="Your Student ID..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button id="login-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                    <span id="login-btn-text">Login / Start</span>
                    <div id="login-spinner" class="loader hidden ml-3"></div>
                </button>
            </div>
            <p id="login-error" class="text-red-500 text-sm mt-2 h-4"></p>
            <p id="teacher-admin-link" class="absolute bottom-4 right-4 text-xs text-gray-400 hover:text-blue-500 cursor-pointer">Teacher Admin</p>
        </div>
    </div>

    <!-- Teacher Code Entry Screen -->
    <div id="teacher-code-overlay" class="absolute inset-0 bg-slate-100 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg text-center max-w-sm w-full relative">
            <h2 class="text-2xl font-bold text-blue-600 mb-2">Teacher Access</h2>
            <p class="text-gray-600 mb-6">Please enter the class code to view student data.</p>
            <div class="space-y-3">
                <input id="teacher-code-input" type="password" placeholder="Class Code..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button id="submit-teacher-code-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">Enter</button>
            </div>
            <p id="teacher-code-error" class="text-red-500 text-sm mt-2 h-4"></p>
            <button id="back-from-code-btn" class="text-sm text-gray-500 hover:text-red-500 font-semibold mt-6">Back</button>
        </div>
    </div>
    
    <!-- Deck Selection Screen -->
    <div id="deck-selection-overlay" class="absolute inset-0 bg-slate-100 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg text-center max-w-sm w-full relative">
            <div id="open-settings-btn" title="Customize daily goals" class="absolute top-4 right-4 text-gray-400 hover:text-blue-500 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </div>
            <h2 id="welcome-message" class="text-2xl font-bold text-blue-600 mb-2">Welcome!</h2>
            <p id="deck-selection-message" class="text-gray-600 mb-6">Please select a deck to begin your session.</p>
            <div id="deck-buttons" class="space-y-3">
                <button data-deck="hsk2" class="deck-btn w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors">HSK 2</button>
                <button data-deck="hsk3" class="deck-btn w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 transition-colors">HSK 3</button>
                <button data-deck="hsk4" class="deck-btn w-full bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-600 transition-colors">HSK 4</button>
                <button data-deck="complete" class="deck-btn w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">Complete</button>
            </div>
             <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-500 font-semibold mt-6">Log Out</button>
        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacher-dashboard-overlay" class="absolute inset-0 bg-slate-100 p-4 md:p-8 hidden">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg max-w-4xl w-full mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-600">Teacher Dashboard</h2>
                <button id="back-to-login-screen-btn" class="text-sm text-gray-500 hover:text-red-500 font-semibold">Back to Login</button>
            </div>
            <div id="student-list-container" class="space-y-2 max-h-[70vh] overflow-y-auto">
                <!-- Student list will be populated here -->
            </div>
        </div>
    </div>


    <!-- Main App -->
    <div id="app-container" class="max-w-2xl w-full mx-auto p-4 md:p-6 bg-white rounded-2xl shadow-lg hidden">
        <header class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg -m-2">
             <div class="flex justify-between items-center">
                <h1 id="deck-title" class="text-3xl font-bold text-blue-600">Flashcard Deck</h1>
                 <div class="flex items-center space-x-4">
                    <button id="change-deck-btn" class="text-sm text-gray-500 hover:text-blue-500 font-semibold">Change Deck</button>
                    <div id="help-icon" title="How ratings work" class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 font-bold cursor-pointer hover:bg-blue-200 hover:text-blue-700 transition-colors text-sm">?</div>
                </div>
            </div>
            <p id="student-id-display" class="text-left text-gray-500 text-sm mt-1"></p>
            <p id="deck-stats" class="text-center text-gray-500 mt-2">Loading stats...</p>
            <p id="daily-goals-stats" class="text-center text-gray-600 font-semibold text-sm mt-1"></p>
            <nav class="flex justify-center border-b mt-4">
                <button id="review-tab-btn" class="px-6 py-2 font-semibold text-blue-600 border-b-2 border-blue-600">Review</button>
                <button id="edit-tab-btn" class="px-6 py-2 font-semibold text-gray-500">Edit</button>
            </nav>
        </header>

        <main>
            <!-- Review Section -->
            <div id="review-section">
                <div id="card-area" class="card-container h-64">
                     <div id="no-cards-message" class="hidden text-center text-gray-500 pt-20">
                        <p class="font-semibold text-lg">Deck is empty!</p>
                        <p>Go to the "Edit" tab to add your first card.</p>
                    </div>
                    <div id="all-done-message" class="hidden text-center text-gray-500 pt-20">
                        <p class="font-semibold text-lg">All done for now!</p>
                        <p>Come back later to review more cards.</p>
                    </div>
                    <div id="current-card" class="card w-full h-full rounded-lg shadow-md">
                        <div class="card-face card-face-front bg-white border-2 border-gray-200 rounded-lg p-4">
                            <p id="card-front" class="text-xl text-center"></p>
                        </div>
                        <div class="card-face card-face-back bg-blue-100 border-2 border-blue-200 rounded-lg p-4">
                            <p id="card-back" class="text-xl text-center"></p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div id="action-buttons" class="mt-6 flex flex-col items-center">
                    <button id="show-answer-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow-sm">Show Answer</button>
                    <div id="rating-buttons" class="hidden w-full grid grid-cols-4 gap-3 mt-4">
                        <button data-rating="again" class="rating-btn bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition-colors shadow-sm">Again</button>
                        <button data-rating="hard" class="rating-btn bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition-colors shadow-sm">Hard</button>
                        <button data-rating="good" class="rating-btn bg-yellow-500 text-white py-3 rounded-lg hover:bg-yellow-600 transition-colors shadow-sm">Good</button>
                        <button data-rating="easy" class="rating-btn bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-colors shadow-sm">Easy</button>
                    </div>
                </div>
            </div>

            <!-- Edit Deck Section -->
            <div id="edit-deck-section" class="hidden">
                <div class="flex justify-end mb-4">
                     <button id="open-add-card-modal-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow-sm">+ Add New Card</button>
                </div>
                <div class="border rounded-lg max-h-80 overflow-y-auto bg-slate-50">
                    <div id="card-list-container" class="divide-y divide-slate-200">
                        <!-- Card list will be dynamically populated here -->
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Add Card Modal -->
    <div id="add-card-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-lg w-full">
            <h3 class="text-xl font-bold text-blue-600 mb-4">Add New Card</h3>
            <form id="add-card-form">
                <div class="space-y-4">
                    <div>
                        <label for="front" class="block text-sm font-medium text-gray-700 mb-1">Front</label>
                        <textarea id="front" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    <div>
                        <label for="back" class="block text-sm font-medium text-gray-700 mb-1">Back</label>
                        <textarea id="back" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
                <p id="add-card-feedback" class="text-green-600 text-center mt-4 h-5"></p>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-add-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Add Card</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Card Modal -->
    <div id="edit-card-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-lg w-full">
            <h3 class="text-xl font-bold text-blue-600 mb-4">Edit Card</h3>
            <div class="space-y-4">
                <div>
                    <label for="edit-front" class="block text-sm font-medium text-gray-700 mb-1">Front</label>
                    <textarea id="edit-front" rows="3" class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
                </div>
                <div>
                    <label for="edit-back" class="block text-sm font-medium text-gray-700 mb-1">Back</label>
                    <textarea id="edit-back" rows="3" class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-edit-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Card Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Are you sure?</h3>
            <p class="text-gray-600 mb-6">This card will be permanently deleted.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Delete</button>
            </div>
        </div>
    </div>

    <!-- Delete Student Confirmation Modal -->
    <div id="delete-student-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Delete Student?</h3>
            <p class="text-gray-600 mb-6">This will permanently delete all data for <strong id="student-name-to-delete"></strong>. This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-student-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-student-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Delete Student</button>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-blue-600">How Ratings Work</h3>
                <button id="close-help-btn" class="text-gray-400 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <ul class="space-y-4 text-gray-700">
                <li class="flex items-start"><div class="w-4 h-4 rounded-full bg-red-500 mr-3 mt-1 flex-shrink-0"></div><div><strong>Again:</strong> You didn't know the answer. The card will show up again in about 1 minute.</div></li>
                <li class="flex items-start"><div class="w-4 h-4 rounded-full bg-orange-500 mr-3 mt-1 flex-shrink-0"></div><div><strong>Hard:</strong> You struggled to remember. The card will come back sooner than "Good".</div></li>
                <li class="flex items-start"><div class="w-4 h-4 rounded-full bg-yellow-500 mr-3 mt-1 flex-shrink-0"></div><div><strong>Good:</strong> You remembered, but it took some effort. The review interval will increase significantly.</div></li>
                <li class="flex items-start"><div class="w-4 h-4 rounded-full bg-green-500 mr-3 mt-1 flex-shrink-0"></div><div><strong>Easy:</strong> You knew the answer instantly. The review interval will increase even more, pushing the card far into the future.</div></li>
            </ul>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full">
            <h3 class="text-xl font-bold text-blue-600 mb-6">Customize Daily Goals</h3>
            <div class="space-y-4">
                <div>
                    <label for="new-cards-goal-input" class="block text-sm font-medium text-gray-700 mb-1">New Cards Per Day</label>
                    <input id="new-cards-goal-input" type="number" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label for="reviews-goal-input" class="block text-sm font-medium text-gray-700 mb-1">Reviews Per Day</label>
                    <input id="reviews-goal-input" type="number" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <p id="settings-feedback" class="text-red-500 text-center mt-4 h-5"></p>
            <div class="mt-8 flex justify-end space-x-3">
                <button id="cancel-settings-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-settings-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save Goals</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, writeBatch, query, getDocs, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- DOM ELEMENTS ---
        const loginOverlay = document.getElementById('login-overlay');
        const studentIdInput = document.getElementById('student-id-input');
        const studentNameInput = document.getElementById('student-name-input');
        const loginBtn = document.getElementById('login-btn');
        const loginSpinner = document.getElementById('login-spinner');
        const loginBtnText = document.getElementById('login-btn-text');
        const loginError = document.getElementById('login-error');
        const deckSelectionOverlay = document.getElementById('deck-selection-overlay');
        const welcomeMessage = document.getElementById('welcome-message');
        const deckSelectionMessage = document.getElementById('deck-selection-message');
        const deckButtons = document.getElementById('deck-buttons');
        const logoutBtn = document.getElementById('logout-btn');
        const appContainer = document.getElementById('app-container');
        const studentIdDisplay = document.getElementById('student-id-display');
        const deckTitle = document.getElementById('deck-title');
        const changeDeckBtn = document.getElementById('change-deck-btn');
        const reviewTabBtn = document.getElementById('review-tab-btn');
        const editTabBtn = document.getElementById('edit-tab-btn');
        const reviewSection = document.getElementById('review-section');
        const editDeckSection = document.getElementById('edit-deck-section');
        const deckStatsEl = document.getElementById('deck-stats');
        const dailyGoalsStatsEl = document.getElementById('daily-goals-stats');
        const currentCardEl = document.getElementById('current-card');
        const cardFrontEl = document.getElementById('card-front');
        const cardBackEl = document.getElementById('card-back');
        const noCardsMessage = document.getElementById('no-cards-message');
        const allDoneMessage = document.getElementById('all-done-message');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const ratingButtons = document.getElementById('rating-buttons');
        const addCardForm = document.getElementById('add-card-form');
        const frontInput = document.getElementById('front');
        const backInput = document.getElementById('back');
        const addCardFeedback = document.getElementById('add-card-feedback');
        const cardListContainer = document.getElementById('card-list-container');
        // Modals
        const addCardModal = document.getElementById('add-card-modal');
        const openAddCardModalBtn = document.getElementById('open-add-card-modal-btn');
        const cancelAddBtn = document.getElementById('cancel-add-btn');
        const editCardModal = document.getElementById('edit-card-modal');
        const editFrontInput = document.getElementById('edit-front');
        const editBackInput = document.getElementById('edit-back');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteStudentConfirmModal = document.getElementById('delete-student-confirm-modal');
        const studentNameToDeleteEl = document.getElementById('student-name-to-delete');
        const cancelDeleteStudentBtn = document.getElementById('cancel-delete-student-btn');
        const confirmDeleteStudentBtn = document.getElementById('confirm-delete-student-btn');
        const helpModal = document.getElementById('help-modal');
        const helpIcon = document.getElementById('help-icon');
        const closeHelpBtn = document.getElementById('close-help-btn');
        const settingsModal = document.getElementById('settings-modal');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const newCardsGoalInput = document.getElementById('new-cards-goal-input');
        const reviewsGoalInput = document.getElementById('reviews-goal-input');
        const settingsFeedback = document.getElementById('settings-feedback');
        // Teacher Elements
        const teacherAdminLink = document.getElementById('teacher-admin-link');
        const teacherCodeOverlay = document.getElementById('teacher-code-overlay');
        const teacherCodeInput = document.getElementById('teacher-code-input');
        const submitTeacherCodeBtn = document.getElementById('submit-teacher-code-btn');
        const teacherCodeError = document.getElementById('teacher-code-error');
        const backFromCodeBtn = document.getElementById('back-from-code-btn');
        const teacherDashboardOverlay = document.getElementById('teacher-dashboard-overlay');
        const backToLoginScreenBtn = document.getElementById('back-to-login-screen-btn');
        const studentListContainer = document.getElementById('student-list-container');
        
        // --- FIREBASE & STATE ---
        let db, auth;
        let deck = [];
        let sessionQueue = [];
        let sessionRepeatPile = [];
        let sessionSeenCardIds = new Set();
        let currentCard = null;
        let userLoginId = null; 
        let deckId = null;
        let unsubscribeFromDeck; 
        let reviewStartTime = null;
        let dailyStats = { newCardsSeen: 0, reviewsDone: 0 };
        let cardIdToEditOrDelete = null;
        let studentToDelete = null;
        let userGoals = { newCards: 25, reviews: 50 };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        async function initializeFirebase() {
            try {
                let firebaseConfig;
                let initialAuthToken = null;

                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    firebaseConfig = JSON.parse(__firebase_config);
                    initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                } else {
                    firebaseConfig = {
                      apiKey: "AIzaSyDLb2nmy5HYNNNTdS87pdDqLZk7TkVK-Rc",
                      authDomain: "mand12cards.firebaseapp.com",
                      projectId: "mand12cards",
                      storageBucket: "mand12cards.appspot.com",
                      messagingSenderId: "916004335850",
                      appId: "1:916004335850:web:1a967ff0f3d26843f16793"
                    };
                }

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("PASTE_YOUR")) {
                     throw new Error("Firebase config not found. If deploying, please paste your project's firebaseConfig object.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                         try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                             console.error("Authentication failed:", error);
                             loginError.textContent = "Connection error.";
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loginError.textContent = error.message;
            }
        }
       
        const startUserSession = async (studentId, studentName) => {
            userLoginId = studentId;
            sessionStorage.setItem('userLoginId', userLoginId);

            const profileRef = doc(db, `artifacts/${appId}/public/data/students/${userLoginId}/profile/info`);
            const profileSnap = await getDoc(profileRef);
            
            if (!profileSnap.exists()) {
                await setDoc(profileRef, { name: studentName, createdAt: Date.now() });
            }
            
            const studentProfileRef = doc(db, `artifacts/${appId}/public/data/student_profiles/${userLoginId}`);
            const studentProfileSnap = await getDoc(studentProfileRef);
            if (!studentProfileSnap.exists()){
                 await setDoc(studentProfileRef, { name: studentName, studentId: userLoginId });
            }
            
            const profileData = (await getDoc(profileRef)).data();
            const userName = profileData.name || studentName;
            
            if (profileData.customGoals) {
                userGoals = profileData.customGoals;
            } else {
                userGoals = { newCards: 25, reviews: 50 };
            }

            welcomeMessage.textContent = `Welcome, ${userName}!`;
            loginOverlay.classList.add('hidden');
            
            const savedDeckId = sessionStorage.getItem('deckId');
            if (savedDeckId) {
                await handleDeckSelection(savedDeckId);
            } else {
                deckSelectionOverlay.classList.remove('hidden');
            }
        };

        const handleLogin = async () => {
            const enteredId = studentIdInput.value.trim();
            const enteredName = studentNameInput.value.trim();
            if (!enteredId || !enteredName) {
                loginError.textContent = "Please enter both your Name and Student ID.";
                return;
            }
            loginError.textContent = "";

            loginBtn.disabled = true;
            loginBtnText.textContent = "Logging In...";
            loginSpinner.classList.remove('hidden');

            try {
                if (enteredId === 'WynR29') {
                    loginOverlay.classList.add('hidden');
                    showTeacherDashboard();
                } else if (enteredId === 'CREATE_MASTER_DECKS') {
                    await populateMasterDecks();
                    loginError.textContent = 'Master decks have been created successfully!';
                }
                else {
                    await startUserSession(enteredId, enteredName);
                }
            } catch (error) {
                console.error("Login failed:", error);
                loginError.textContent = "Login failed. Please try again.";
            } finally {
                loginBtn.disabled = false;
                loginBtnText.textContent = "Login / Start";
                loginSpinner.classList.add('hidden');
            }
        };
        
        const handleLogout = () => {
            if (unsubscribeFromDeck) unsubscribeFromDeck();
            sessionStorage.removeItem('userLoginId');
            sessionStorage.removeItem('deckId');
            userLoginId = null; deckId = null; deck = []; currentCard = null;
            appContainer.classList.add('hidden');
            deckSelectionOverlay.classList.add('hidden');
            loginOverlay.classList.remove('hidden');
        };
        
        const getTodaysDateString = () => new Date().toISOString().split('T')[0];

        const loadDailyStatsForDeck = async () => {
            if (!userLoginId || !deckId) return;
            const statsRef = doc(db, `artifacts/${appId}/public/data/students/${userLoginId}/progress/${deckId}`);
            const statsSnap = await getDoc(statsRef);
            const todayStr = getTodaysDateString();

            if (statsSnap.exists() && statsSnap.data().lastSessionDate === todayStr) {
                dailyStats = statsSnap.data();
            } else {
                dailyStats = { newCardsSeen: 0, reviewsDone: 0, lastSessionDate: todayStr };
                await setDoc(statsRef, dailyStats);
            }
        };

        const updateDailyStatsInFirestore = async () => {
             if (!userLoginId || !deckId) return;
             const statsRef = doc(db, `artifacts/${appId}/public/data/students/${userLoginId}/progress/${deckId}`);
             await setDoc(statsRef, dailyStats, { merge: true });
        };
        
        const startReviewSession = async () => {
            await loadDailyStatsForDeck();

            const newCardsLimit = Math.max(0, userGoals.newCards - (dailyStats.newCardsSeen || 0));
            const reviewCardsLimit = Math.max(0, userGoals.reviews - (dailyStats.reviewsDone || 0));

            const newCards = deck.filter(c => c.status === 'new').slice(0, newCardsLimit);
            const reviewCards = deck.filter(c => c.status === 'practice' && c.nextReviewDate <= Date.now()).slice(0, reviewCardsLimit);
            
            sessionQueue = [...newCards, ...reviewCards].sort(() => Math.random() - 0.5); 
            sessionRepeatPile = [];
            sessionSeenCardIds = new Set();
            
            showNextCard();
        };

        const handleDeckSelection = async (selectedDeckId) => {
            deckButtons.querySelectorAll('button').forEach(btn => btn.disabled = true);
            deckSelectionMessage.textContent = `Preparing ${selectedDeckId.toUpperCase()} deck...`;
            
            deckId = selectedDeckId;
            sessionStorage.setItem('deckId', deckId);
            
            const deckNames = { hsk2: 'HSK 2', hsk3: 'HSK 3', hsk4: 'HSK 4', complete: 'Complete Deck' };
            deckTitle.textContent = deckNames[selectedDeckId] || 'Flashcard Deck';
            
            deckSelectionOverlay.classList.add('hidden');
            appContainer.classList.remove('hidden');
            studentIdDisplay.textContent = `Student ID: ${userLoginId}`;
            loadDeck();
            
            deckButtons.querySelectorAll('button').forEach(btn => btn.disabled = false);
            deckSelectionMessage.textContent = "Please select a deck to begin your session.";
        };

        const handleChangeDeck = () => {
            if (unsubscribeFromDeck) unsubscribeFromDeck(); 
            deck = []; sessionQueue = []; sessionRepeatPile = []; currentCard = null; deckId = null;
            sessionStorage.removeItem('deckId');
            appContainer.classList.add('hidden');
            deckSelectionOverlay.classList.remove('hidden');
        };

        const getMasterDeckCollectionPath = (dId = deckId) => `artifacts/${appId}/public/data/master_decks/${dId}/cards`;
        const getUserProgressCollectionPath = (sId = userLoginId) => `artifacts/${appId}/public/data/students/${sId}/card_progress`;
        const getUserPersonalDeckCollectionPath = (sId = userLoginId) => `artifacts/${appId}/public/data/students/${sId}/personal_decks/cards`;


        const loadDeck = async () => {
            if (!userLoginId || !deckId) return;
            
            const masterDeckCollection = collection(db, getMasterDeckCollectionPath());
            const userProgressCollection = collection(db, getUserProgressCollectionPath());

            const [masterSnapshot, progressSnapshot] = await Promise.all([
                getDocs(masterDeckCollection),
                getDocs(query(collection(db, getUserProgressCollectionPath()), where('deckId', '==', deckId)))
            ]);

            const userProgress = {};
            progressSnapshot.forEach(doc => {
                userProgress[doc.id] = doc.data();
            });

            deck = masterSnapshot.docs.map(doc => {
                const masterCard = { id: doc.id, ...doc.data() };
                const progress = userProgress[masterCard.id];
                return { ...masterCard, ...progress };
            });

            switchTab('review');
        };
        
        const updateStatsUI = () => {
            const newCountInQueue = sessionQueue.filter(c => (!c.status || c.status === 'new') && !sessionSeenCardIds.has(c.id)).length;
            const reviewCountInQueue = sessionQueue.filter(c => c.status === 'practice').length;
            const repeatCount = sessionRepeatPile.length;

            deckStatsEl.innerHTML = `
                <span class="text-blue-600 font-semibold">New: ${newCountInQueue}</span> | 
                <span class="text-green-600 font-semibold">Practice: ${reviewCountInQueue}</span> |
                <span class="text-red-600 font-semibold">Repeating: ${repeatCount}</span>
            `;
            dailyGoalsStatsEl.textContent = `Today's Progress — New: ${dailyStats.newCardsSeen}/${userGoals.newCards}, Reviews: ${dailyStats.reviewsDone}/${userGoals.reviews}`;
        };

        const showNextCard = () => {
            currentCardEl.style.transition = 'none';
            currentCardEl.classList.remove('is-flipped');
            setTimeout(() => {
                currentCardEl.style.transition = 'transform 0.6s';
            }, 50);

            ratingButtons.classList.add('hidden');
            showAnswerBtn.classList.remove('hidden');
            reviewStartTime = Date.now();
            
            if (sessionQueue.length > 0) {
                currentCard = sessionQueue.shift(); 
            } else if (sessionRepeatPile.length > 0) {
                currentCard = sessionRepeatPile.shift(); 
            } else {
                currentCard = null;
            }

            if (currentCard) {
                cardFrontEl.textContent = currentCard.front;
                cardBackEl.textContent = currentCard.back;
                currentCardEl.classList.remove('hidden');
                noCardsMessage.classList.add('hidden');
                allDoneMessage.classList.add('hidden');
            } else {
                 if (deck.length === 0) {
                    noCardsMessage.classList.remove('hidden');
                } else {
                    allDoneMessage.innerHTML = `<p class="font-semibold text-lg">All done for this session!</p><p>Great work.</p>`;
                    allDoneMessage.classList.remove('hidden');
                }
                currentCardEl.classList.add('hidden');
                showAnswerBtn.classList.add('hidden');
            }
            updateStatsUI();
        };

        const handleShowAnswer = () => {
            currentCardEl.classList.add('is-flipped');
            showAnswerBtn.classList.add('hidden');
            ratingButtons.classList.remove('hidden');
        };

        const handleRating = async (e) => {
            if (!currentCard) return;
            ratingButtons.querySelectorAll('button').forEach(btn => btn.disabled = true);

            try {
                const reviewSpeed = Date.now() - reviewStartTime;
                const rating = e.target.dataset.rating;
                const wasCorrect = rating !== 'again';
                const isNewCard = !currentCard.status || currentCard.status === 'new';
                const cardId = currentCard.id;
                const hasBeenSeenThisSession = sessionSeenCardIds.has(cardId);

                const reviewHistoryRef = collection(db, `artifacts/${appId}/public/data/students/${userLoginId}/reviewHistory`);
                await addDoc(reviewHistoryRef, { cardId: currentCard.id, deckId, timestamp: Date.now(), speed: reviewSpeed, correct: wasCorrect, isNew: isNewCard });

                if (!hasBeenSeenThisSession) {
                    if (isNewCard) {
                        dailyStats.newCardsSeen++;
                    } else {
                        dailyStats.reviewsDone++;
                    }
                    await updateDailyStatsInFirestore();
                    sessionSeenCardIds.add(cardId);
                }
                
                const updates = {};
                updates.status = 'practice';
                updates.deckId = deckId;

                if (rating === 'again' || rating === 'hard') {
                    const cardForRepeat = { ...currentCard, status: 'practice' };
                    sessionRepeatPile.push(cardForRepeat);
                    
                    if (isNewCard) {
                         const progressRef = doc(db, getUserProgressCollectionPath(), cardId);
                         await setDoc(progressRef, updates, { merge: true });
                    }
                } else {
                    const now = new Date();
                    let nextInterval;
                    const currentInterval = currentCard.interval || 1;
                    if (rating === 'good') {
                        nextInterval = isNewCard ? 1 * 24 * 60 : currentInterval * 2.5; // 1 day for new, 2.5x for seen
                    } else { // easy
                        nextInterval = isNewCard ? 4 * 24 * 60 : currentInterval * 4; // 4 days for new, 4x for seen
                    }
                    updates.interval = Math.max(1, parseFloat(nextInterval.toFixed(1)));
                    updates.nextReviewDate = now.getTime() + updates.interval * 60 * 1000;
                    
                    const progressRef = doc(db, getUserProgressCollectionPath(), cardId);
                    await setDoc(progressRef, updates, { merge: true });
                }
            } catch (error) {
                console.error("Error processing rating:", error);
            } finally {
                showNextCard();
                ratingButtons.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
        };
            
        const handleAddCard = async (e) => {
            e.preventDefault();
            const addBtn = e.target.querySelector('button[type="submit"]');
            addBtn.disabled = true;

            const front = frontInput.value.trim(); const back = backInput.value.trim();
            if (!front || !back) {
                addBtn.disabled = false;
                return;
            }
            const newCard = { front, back, nextReviewDate: Date.now(), interval: 1, status: 'new' };
            
            try {
                // User-added cards go to their personal deck AND complete deck
                const personalDeckCollection = collection(db, `artifacts/${appId}/public/data/students/${userLoginId}/decks/personal/cards`);
                await addDoc(personalDeckCollection, newCard);
                
                const completeDeckCollection = collection(db, `artifacts/${appId}/public/data/students/${userLoginId}/decks/complete/cards`);
                await addDoc(completeDeckCollection, newCard);

                frontInput.value = ''; backInput.value = ''; frontInput.focus();
                addCardFeedback.textContent = 'Card added successfully!';
                addCardFeedback.classList.add('text-green-600'); addCardFeedback.classList.remove('text-red-600');
                setTimeout(() => { addCardFeedback.textContent = ''; }, 2000);
            } catch (error) {
                console.error("Error adding card:", error);
                addCardFeedback.textContent = 'Error adding card.';
                addCardFeedback.classList.remove('text-green-600'); addCardFeedback.classList.add('text-red-600');
                setTimeout(() => { addCardFeedback.textContent = ''; }, 2000);
            } finally {
                addBtn.disabled = false;
            }
        };
        
        // --- EDIT DECK FUNCTIONS ---
        const populateCardList = () => {
            cardListContainer.innerHTML = '';
            if (deck.length === 0) {
                cardListContainer.innerHTML = '<p class="p-4 text-center text-gray-500">This deck is empty.</p>';
                return;
            }
            deck.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'p-4 flex justify-between items-center';
                cardEl.innerHTML = `
                    <div class="flex-1 mr-4 overflow-hidden">
                        <p class="font-medium text-gray-800 truncate">${card.front}</p>
                        <p class="text-sm text-gray-500 truncate">${card.back}</p>
                    </div>
                    <div>
                        <button data-id="${card.id}" class="edit-card-btn text-blue-500 hover:text-blue-700 mr-3 font-semibold">Edit</button>
                        <button data-id="${card.id}" class="delete-card-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                    </div>
                `;
                cardListContainer.appendChild(cardEl);
            });
        };
        
        const openEditModal = (cardId) => {
            const card = deck.find(c => c.id === cardId);
            if (!card) return;
            cardIdToEditOrDelete = cardId;
            editFrontInput.value = card.front;
            editBackInput.value = card.back;
            editCardModal.classList.remove('hidden');
        };
        
        const closeEditModal = () => {
            cardIdToEditOrDelete = null;
            editCardModal.classList.add('hidden');
        };

        const handleSaveChanges = async () => {
            saveEditBtn.disabled = true;
            const newFront = editFrontInput.value.trim();
            const newBack = editBackInput.value.trim();

            if (!cardIdToEditOrDelete || !newFront || !newBack) {
                saveEditBtn.disabled = false;
                return;
            };

            const cardRef = doc(db, getMasterDeckCollectionPath(), cardIdToEditOrDelete);
            try {
                await updateDoc(cardRef, { front: newFront, back: newBack });
                closeEditModal();
            } catch (error) {
                console.error("Error updating card:", error);
            } finally {
                saveEditBtn.disabled = false;
            }
        };
        
        const openDeleteConfirm = (cardId) => {
            cardIdToEditOrDelete = cardId;
            deleteConfirmModal.classList.remove('hidden');
        };

        const closeDeleteConfirm = () => {
            cardIdToEditOrDelete = null;
            deleteConfirmModal.classList.add('hidden');
        };

        const handleDeleteCard = async () => {
            if (!cardIdToEditOrDelete) return;
            confirmDeleteBtn.disabled = true;
            const cardRef = doc(db, getMasterDeckCollectionPath(), cardIdToEditOrDelete);
            try {
                await deleteDoc(cardRef);
                closeDeleteConfirm();
            } catch (error) {
                console.error("Error deleting card:", error);
            } finally {
                confirmDeleteBtn.disabled = false;
            }
        };
            
        const switchTab = (tab) => {
            const tabs = {
                review: { section: reviewSection, btn: reviewTabBtn },
                edit: { section: editDeckSection, btn: editTabBtn }
            };

            Object.values(tabs).forEach(({ section, btn }) => {
                section.classList.add('hidden');
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.add('text-gray-500');
            });

            tabs[tab].section.classList.remove('hidden');
            tabs[tab].btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');

            if (tab === 'review') {
                startReviewSession();
            }
            else if (tab === 'edit') {
                 populateCardList();
            }
        };
        
        // --- SETTINGS FUNCTIONS ---
        const openSettingsModal = () => {
            newCardsGoalInput.value = userGoals.newCards;
            reviewsGoalInput.value = userGoals.reviews;
            settingsModal.classList.remove('hidden');
        };

        const closeSettingsModal = () => {
            settingsFeedback.textContent = '';
            settingsModal.classList.add('hidden');
        };

        const handleSaveSettings = async () => {
            saveSettingsBtn.disabled = true;
            const newCards = parseInt(newCardsGoalInput.value, 10);
            const newReviews = parseInt(reviewsGoalInput.value, 10);

            if (isNaN(newCards) || isNaN(newReviews) || newCards < 0 || newReviews < 0) {
                settingsFeedback.textContent = 'Please enter valid numbers.';
                saveSettingsBtn.disabled = false;
                return;
            }

            userGoals = { newCards, reviews: newReviews };
            
            const profileRef = doc(db, `artifacts/${appId}/public/data/students/${userLoginId}/profile/info`);
            try {
                await setDoc(profileRef, { customGoals: userGoals }, { merge: true });
                updateStatsUI();
                closeSettingsModal();
            } catch (error) {
                console.error("Error saving settings:", error);
                settingsFeedback.textContent = 'Could not save settings.';
            } finally {
                saveSettingsBtn.disabled = false;
            }
        };

        // --- TEACHER DASHBOARD FUNCTIONS ---
        const showTeacherDashboard = async () => {
            loginOverlay.classList.add('hidden');
            deckSelectionOverlay.classList.add('hidden');
            appContainer.classList.add('hidden');
            teacherDashboardOverlay.classList.remove('hidden');
            
            studentListContainer.innerHTML = '<p class="text-center text-gray-500">Loading students...</p>';

            const profilesRef = collection(db, `artifacts/${appId}/public/data/student_profiles`);
            const snapshot = await getDocs(profilesRef);

            if (snapshot.empty) {
                studentListContainer.innerHTML = '<p class="text-center text-gray-500">No students have registered yet.</p>';
                return;
            }
            
            studentListContainer.innerHTML = '';
            const students = snapshot.docs.map(doc => doc.data());
            students.forEach(student => {
                const studentEl = document.createElement('div');
                studentEl.className = 'bg-slate-50 p-4 rounded-lg';
                studentEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg text-slate-800">${student.name}</p>
                            <p class="text-sm text-slate-500">${student.studentId}</p>
                        </div>
                        <div class="space-x-2">
                            <button data-id="${student.studentId}" class="view-stats-btn text-blue-500 hover:text-blue-700 font-semibold">View Analytics</button>
                            <button data-id="${student.studentId}" data-name="${student.name}" class="delete-student-btn text-red-500 hover:text-red-700 font-semibold">Delete User</button>
                        </div>
                    </div>
                    <div id="stats-container-${student.studentId}" class="stats-container mt-4 pt-4 border-t border-slate-200">
                        <!-- Per-deck stats will be loaded here -->
                        <p class="text-center text-gray-500">Loading analytics...</p>
                    </div>
                `;
                studentListContainer.appendChild(studentEl);
            });
        };
        
        const toggleStudentStats = async (studentId) => {
            const container = document.getElementById(`stats-container-${studentId}`);
            if (!container) return;

            if(container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                return;
            }
            
            container.classList.add('expanded');
            
            try {
                const historyRef = collection(db, `artifacts/${appId}/public/data/students/${studentId}/reviewHistory`);
                const snapshot = await getDocs(historyRef);
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">No review data found for this student.</p>';
                    return;
                }
                const reviews = snapshot.docs.map(doc => doc.data());

                const deckIds = ['hsk2', 'hsk3', 'hsk4', 'complete'];
                let statsHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

                deckIds.forEach(deckId => {
                    const deckReviews = reviews.filter(r => r.deckId === deckId);
                    const deckName = { hsk2: 'HSK 2', hsk3: 'HSK 3', hsk4: 'HSK 4', complete: 'Complete' }[deckId];

                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                    const weekStart = todayStart - (7 * 24 * 60 * 60 * 1000);
                    const monthStart = todayStart - (30 * 24 * 60 * 60 * 1000);
                    
                    const calculateStats = (reviewArray) => {
                        if (reviewArray.length === 0) return { count: 0, accuracy: '0%', speed: '0s' };
                        const correctCount = reviewArray.filter(r => r.correct).length;
                        const totalSpeed = reviewArray.reduce((sum, r) => sum + r.speed, 0);
                        return {
                            count: reviewArray.length,
                            accuracy: ((correctCount / reviewArray.length) * 100).toFixed(1) + '%',
                            speed: (totalSpeed / reviewArray.length / 1000).toFixed(1) + 's'
                        };
                    };
                    
                    const todayStats = calculateStats(deckReviews.filter(r => r.timestamp >= todayStart));
                    const weekStats = calculateStats(deckReviews.filter(r => r.timestamp >= weekStart));
                    const monthStats = calculateStats(deckReviews.filter(r => r.timestamp >= monthStart));

                    statsHtml += `
                        <div class="bg-white p-3 rounded-md shadow-sm border border-slate-200">
                            <h4 class="font-bold text-blue-700 mb-2">${deckName} Deck</h4>
                            <div class="text-xs space-y-1 text-slate-600">
                                <p><strong>Today:</strong> ${todayStats.count} reviews, ${todayStats.accuracy} acc, ${todayStats.speed} avg.</p>
                                <p><strong>This Week:</strong> ${weekStats.count} reviews, ${weekStats.accuracy} acc, ${weekStats.speed} avg.</p>
                                <p><strong>This Month:</strong> ${monthStats.count} reviews, ${monthStats.accuracy} acc, ${monthStats.speed} avg.</p>
                            </div>
                        </div>
                    `;
                });

                statsHtml += '</div>';
                container.innerHTML = statsHtml;

            } catch (error) {
                console.error("Error fetching student data:", error);
                container.innerHTML = '<p class="text-center text-red-500">Could not load analytics.</p>';
            }
        };

        const hideTeacherDashboard = () => {
            teacherDashboardOverlay.classList.add('hidden');
            loginOverlay.classList.remove('hidden');
        };

        const openDeleteStudentConfirm = (studentId, studentName) => {
            studentToDelete = { id: studentId, name: studentName };
            studentNameToDeleteEl.textContent = `${studentName} (${studentId})`;
            deleteStudentConfirmModal.classList.remove('hidden');
        };

        const closeDeleteStudentConfirm = () => {
            studentToDelete = null;
            deleteStudentConfirmModal.classList.add('hidden');
        };
        
        const deleteStudentData = async () => {
            if (!studentToDelete) return;
            confirmDeleteStudentBtn.disabled = true;
            const { id: studentId } = studentToDelete;
            console.log(`Deleting all data for student: ${studentId}`);
            
            try {
                // Delete user's card progress
                const progressCollectionPath = getUserProgressCollectionPath(studentId);
                const progressSnapshot = await getDocs(collection(db, progressCollectionPath));
                const progressBatch = writeBatch(db);
                progressSnapshot.docs.forEach(doc => progressBatch.delete(doc.ref));
                await progressBatch.commit();
                
                // Delete user's personal decks
                const personalDeckPath = `artifacts/${appId}/public/data/students/${studentId}/decks/personal/cards`;
                const personalDeckSnapshot = await getDocs(collection(db, personalDeckPath));
                const personalDeckBatch = writeBatch(db);
                personalDeckSnapshot.docs.forEach(doc => personalDeckBatch.delete(doc.ref));
                await personalDeckBatch.commit();

                // Delete review history
                const historyCollectionPath = `artifacts/${appId}/public/data/students/${studentId}/reviewHistory`;
                const historySnapshot = await getDocs(collection(db, historyCollectionPath));
                const historyBatch = writeBatch(db);
                historySnapshot.docs.forEach(doc => historyBatch.delete(doc.ref));
                await historyBatch.commit();

                // Delete top-level profile and progress docs
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/students/${studentId}/profile/info`));
                // Delete all daily stat docs
                 const deckIds = ['hsk2', 'hsk3', 'hsk4', 'complete'];
                 for (const deckId of deckIds) {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/students/${studentId}/progress/${deckId}`));
                 }

                // Delete from the student index
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/student_profiles/${studentId}`));

                console.log(`Successfully deleted student ${studentId}`);
                closeDeleteStudentConfirm();
                showTeacherDashboard(); // Refresh the list
            } catch (error) {
                console.error("Error deleting student data:", error);
                alert("An error occurred while deleting the student.");
                closeDeleteStudentConfirm();
            } finally {
                confirmDeleteStudentBtn.disabled = false;
            }
        };

        // --- DECK POPULATION ---
        const populateMasterDecks = async () => {
            const hsk2Data = `
                我;wǒ;I, me
                我们;wǒmen;we, us
                你;nǐ;you
                你们;nǐmen;you (plural)
                他;tā;he, him
                她;tā;she, her
                他们;tāmen;they (male + female/male)
                她们;tāmen;they (female)
                您;nín;you
                它;tā;it
                大家;dàjiā;everyone
                每;měi;every
                这(这儿);zhè (zhèr);here, this
                那(那儿);nà (nàr);there, that
                哪（哪儿）;nǎ (nǎr);where
                谁;shéi;who
                什么;shénme;what, why
                多少;duōshǎo;how many, how much
                几;jǐ;a few, how many
                怎么;zěnme;how
                怎么样;zěnmeyàng;how about
                为什么;wèishénme;why
                一;yī;one
                二;èr;two
                三;sān;three
                四;sì;four
                五;wǔ;five
                六;liù;six
                七;qī;seven
                八;bā;eight
                九;jiǔ;nine
                十;shí;ten
                零;líng;zero
                两;liǎng;two
                百;bǎi;hundred
                千;qiān;thousand
                第一;dìyī;first
                个;gè;one, a, an
                岁;suì;year
                本;běn;volume
                些;xiē;some
                块;kuài;piece
                次;cì;number
                公斤;gōngjīn;kilogram
                元;yuán;yuan
                件;jiàn;piece
                张;zhāng;sheet
                不;bù;no
                没;méi;no
                很;hěn;quite, very
                太;tài;too
                都;dōu;all
                别;bié;other
                非常;fēicháng;very
                也;yě;likewise
                还;hái;repay
                最;zuì;most
                真;zhēn;real
                正在;zhèngzài;be being
                已经;yǐjīng;already
                一起;yìqǐ;together
                再;zài;again
                就;jiǜ;at once
                和;hé;and
                因为;yīnwèi;because
                所以;suǒyǐ;so
                但是;dànshì;but
                在;zài;in, at
                从;cóng;from
                对;duì;right
                此;cǐ;this
                向;xiàng;towards
                离;lí;leave
                喂;wèi;hello
                家;jiā;home
                学校;xuéxiào;school
                饭馆;fàn guǎn;restaurant
                商店;shāngdiàn;store
                医院;yīyuàn;hospital
                火车站;huǒchēzhàn;train station
                中国;zhōngguó;China
                機場;jīchǎng;airport
                教室;jiàoshì;classroom
                房间;fángjiān;room
                路;lù;road
                北京;běijīng;Beijing
                上;shàng;up
                下;xià;below
                前面;qiánmiàn;front
                后面;hòumiàn;behind
                左边;zuǒbiān;left
                右边;yòubiān;right
                外;wài;out
                旁边;pángbiān;side
                里面;lǐmiàn;inside
                今天;jīntiān;today
                明天;míngtiān;tomorrow
                昨天;zuótiān;yesterday
                上午;shàngwǔ;morning
                中午;zhōngwǔ;noon
                下午;xiàwǔ;afternoon
                年;nián;year
                月;yuè;month
                日;rì;day
                星期;xīngqī;week
                点;diǎn;dot, spot
                分钟;fēnzhōng;minute
                现在;xiànzài;now
                时候;shíhóu;time
                早上;zǎoshàng;morning
                晚上;wǎnshàng;night
                小时;xiǎoshí;hour
                时间;shíjiān;time
                去年;qùnián;last year
                号;hào;number
                生日;shēngrì;birthday
                爸爸;bàba;father
                妈妈;māma;mother
                儿子;érzi;son
                女儿;nǚér;daughter
                老师;lǎoshī;teacher
                学生;xuéshēng;student
                同学;tóngxué;shoolmate
                朋友;péngyǒu;friend
                医生;yīshēng;doctor
                先生;xiānshēng;sir
                小姐;xiǎojiě;Miss
                哥哥;gēge;brother
                姐姐;jiějie;sister
                弟弟;dìdi;younger brother
                妹妹;mèimei;sis
                丈夫;zhàngfu;husband
                妻子;qīzi;wife
                孩子;háizi;child
                男人;nánrén;man
                女人;nǚrén;woman
                服务员;fúwùyuán;waiter
                衣服;yīfu;cloth
                水;shuǐ;water
                菜;cài;vegetable
                米饭;mǐfàn;rice
                水果;shuǐguǒ;fruit
                苹果;píngguǒ;apple
                茶;chá;tea
                杯子;bēizi;cup
                钱;qián;money
                飞机;fēijī;airplane
                出租车;chūzūchē;taxi
                电视;diànshì;television
                电脑;diànnǎo;computer
                电影;diànyǐng;movie
                天气;tiānqì;weather
                猫;māo;cat
                狗;gǒu;dog
                东西;dōngxī;thing
                鱼;yú;fish
                羊肉;yángròu;mutton
                牛奶;niúnǎi;milk
                鸡蛋;jīdàn;egg
                西瓜;xīguā;watermelon
                咖啡;kāfēi;coffee
                自行车;zìxíngchē;bike
                船;chuán;boat
                雪;xué;snow
                药;yào;medicine
                手机;shǒujī;phone
                手表;shǒubiǎo;watch
                眼睛;yǎnjīng;eye
                身体;shēntǐ;body
                公共汽车;gōnggòngqìchē;bus
                报纸;bàozhǐ;newspaper
                人;rén;person
                名字;míngzi;name
                书;shū;book
                汉语;hànyǔ;Chinese
                字;zì;character
                桌子;zhuōzi;desk
                椅子;yǐzi;chair
                门;mén;door
                题;tí;topic
                课;kè;lesson
                姓;xìng;surname
                问题;wèntí;question
                事情;shìqing;matter
                考试;kǎoshì;exam
                票;piào;ticket
                意思;yìsi;meaning
                颜色;yánsè;color
                谢谢;xièxiè;thank
                不客气;búkèqì;you are welcome
                再见;zàijiàn;good-bye
                请;qǐng;please
                对不起;duìbùqǐ;sorry
                没关系;méiguānxì;It doesn't matter
                欢迎;huānyíng;welcome
                是;shì;am, is, are
                有;yǒu;have
                看;kàn;look
                听;tīng;listen
                说话;shuōhuà;speak
                读;dú;read
                写;xiě;write
                看见;kànjiàn;see
                叫;jiào;call
                来;lái;come
                回;huí;return
                去;qù;go
                吃;chī;eat
                喝;hē;drink
                睡觉;shuìjiào;sleep
                打电话;dǎdiànhuà;call up
                做;zuò;do
                买;mǎi;buy
                开;kāi;open
                坐;zuò;sit
                住;zhù;live
                学习;xuéxí;study
                工作;gōngzuò;work
                下雨;xiàyǔ;rain
                问;wèn;ask
                走;zǒu;walk
                进;jìn;enter
                出;chū;come
                跑步;pǎobù;run
                到;dào;arrive
                穿;chuān;wear
                洗;xǐ;wash
                给;gěi;give
                找;zhǎo;find
                懂;dǒng;understand
                笑;xiào;smile
                回答;huídá;answer
                告诉;gàosù;tell
                准备;zhǔnbèi;prepare
                开始;kāishǐ;begin
                介绍;jièshào;introduce
                帮助;bāngzhù;help
                玩;wán;play
                送;sòng;present
                等;děng;wait
                让;ràng;let
                起床;qǐchuáng;get up
                唱歌;chànggē;sing
                跳舞;tiàowǔ;dance
                旅游;lǚyóu;travel
                上班;shàngbān;be on duty
                生病;shēngbìng;fall ill
                休息;xiūxi;rest
                运动;yùndòng;exercise
                游泳;yóuyǒng;swim
                踢足球;tīzúqiú;play footbal
                打篮球;dǎlánqiú;play basketball
                完;wán;finish
                爱;ài;love
                喜欢;xǐhuān;love, like
                想;xiǎng;want
                认识;rènshi;know
                觉得;juédé;think
                知道;zhīdào;know
                希望;xīwàng;hope
                会;huì;can
                能;néng;can, be able
                可以;kěyǐ;can
                要;yào;ask for
                可能;kěnéng;may
                好;hǎo;good
                大;dà;big
                小;xiǎo;small
                多;duō;many, much
                少;shǎo;few, little
                冷;lěng;cold
                热;rè;hot
                高兴;gāoxìng;happy
                漂亮;piàoliàng;beautiful
                高;gāo;tall
                红;hóng;red
                白;bái;white
                黑;hēi;black
                忙;máng;busy
                快;kuài;fast
                慢;màn;slow
                远;yuǎn;far
                近;jìn;close
                好吃;hǎochī;delicious
                累;lèi;tired
                长;cháng;long
                新;xīn;new
                贵;guì;expensive
                便宜;piányi;cheap
                晴;qíng;fine
                阴;yīn;cloudy
                错;cuò;wrong
                快乐;kuàilè;happy
            `;

            const hsk3Data = `
                阿姨;āyí;aunt
                啊;a;ah
                矮;ǎi;short
                爱好;àihào;hobby
                安静;ānjìng;Be quiet
                把;bǎ;hold
                班;bān;class
                搬;bān;turn; pull
                半;bàn;half
                办法;bànfǎ;Way
                办公室;bàngōngshì;Office
                帮忙;bāngmáng;Help
                包;bāo;package
                饱;bǎo;full
                北方;běifāng;north
                被;bèi;cover
                鼻子;bízi;nose
                比;bǐ;than
                比较;bǐjiào;compare
                比赛;bǐsài;Match
                必须;bìxū;Must
                变化;biànhà;change
                表示;biǎoshì;Express
                表演;biǎoyǎn;perform
                别人;biéren;Others
                宾馆;bīnguǎn;hotel
                冰箱;bīngxiāng;Refrigerator
                才;cái;just
                菜单;càidān;menu
                参加;cānjiā;participate in
                草;cǎo;grass
                层;céng;layer
                差;chà;difference
                超市;chāoshì;Supermarket
                衬衫;chènshān;shirt
                成绩;chéngjì;achievement
                城市;chéngshì;City
                迟到;chídào;Late
                出现;chūxiàn;Appear
                厨房;chúfáng;Kitchen
                除了;chúle;except
                春;chūn;spring
                词语;cíyǔ;terms
                聪明;cōngming;clever
                打扫;dǎsǎo;Clean
                打算;dǎsuàn;Plan
                带;dài;belt
                担心;dānxīn;Worry
                蛋糕;dàngāo;Cake
                当然;dāngrán;Of course
                灯;dēng;lamp
                低;dī;low
                地方;dìfang;local
                地铁;dìtiě;metro
                地图;dìtú;Map
                电梯;diàntī;Elevator
                电子邮件;diànzǐyóujiàn;E-mail
                东;dōng;east
                冬;dōng;winter
                动物;dòngwù;Animal
                短;duǎn;short
                段;duàn;paragraph
                锻炼;duànliàn;Physical exercise
                多么;duōme;what
                饿;è;hungry
                而且;érqiě;And
                耳朵;ěrduo;Ears
                发烧;fāshāo;Have a fever
                发现;fāxiàn;find
                方便;fāngbiàn;convenient
                放;fàng;discharge
                放心;fàngxīn;Don't worry
                分;fēn;branch
                附近;fùjìn;nearby
                复习;fùxí;Review
                干净;gānjìng;clean
                敢;gǎn;dare
                感冒;gǎnmào;Cold
                刚才;gāngcái;just
                根据;gēnjù;according to
                跟;gēn;with
                更;gèng;more
                公司;gōngsī;company
                公园;gōngyuán;Park
                故事;gùshi;Story
                刮风;guāfēng;Windy
                关;guān;shut
                关系;guānxì;relationship
                关心;guānxīn;Care for
                关于;guānyú;about
                国家;guójiā;Country
                果汁;guǒzhī;fruit juice
                过去;guòqù;Past times
                还是;háishì;still
                害怕;hàipà;Fear
                黑板;hēibǎn;blackboard
                后来;hòulái;later
                护照;hùzhào;passport
                花;huā;Flower
                花园;huāyuán;Garden
                画;huà;painting
                坏;huài;bad
                还;huán;still
                环境;huánjìng;Environmental Science
                换;huàn;change
                黄;huáng;yellow
                会议;huìyì;Meeting
                或者;huòzhě;perhaps
                几乎;jīhū;almost
                机会;jīhuì;Opportunity
                极;jí;extremely
                记得;jìde;remember
                季节;jìjié;Season
                检查;jiǎnchá;inspect
                简单;jiǎndān;simple
                健康;jiànkāng;Healthy
                见面;jiànmiàn;meet
                讲;jiǎng;speak
                教;jiāo;teach
                角;jiǎo;horn
                脚;jiǎo;foot
                接;jiē;meet
                街道;jiēdào;Street
                结婚;jiéhūn;marry
                结束;jiéshù;End
                节目;jiémù;program
                节日;jiérì;festival
                解决;jiějué;Solve
                借;jiè;borrow
                经常;jīngcháng;Often
                经过;jīngguò;after
                经理;jīnglǐ;manager
                久;jiǔ;long
                旧;jiù;used
                举行;jǔxíng;hold
                句子;jùzi;sentence
                决定;juédìng;Decision
                渴;kě;thirsty
                可爱;kě'ài;Lovely
                刻;kè;moment
                客人;kèrén;Guest
                空调;kōngtiáo;Air conditioner
                口;kǒu;mouth
                哭;kū;cry
                裤子;kùzi;trousers
                筷子;kuàizi;chopsticks
                蓝;lán;blue
                老;lǎo;old
                离开;líkāi;leave
                礼物;lǐwù;gift
                历史;lìshǐ;History
                脸;liǎn;face
                练习;liànxí;Practice
                辆;liàng;Car
                了解;liǎojiě;understand
                邻居;línjū;neighbor
                楼;lóu;floor
                绿;lǜ;green
                马;mǎ;Horse
                马上;mǎshàng;Right off
                卖;mài;sell
                满意;mǎnyì;Satisfied
                帽子;màozi;Hat
                米;mǐ;rice
                面包;miànbāo;Bread
                面条;miàntiáo;noodle
                明白;míngbai;clear
                拿;ná;take
                奶奶;nǎinai;grandma
                南;nán;south
                难;nán;disaster; blame
                难过;nánguò;Sorry
                年级;niánjí;grade
                年轻;niánqīng;Young
                鸟;niǎo;bird
                努力;nǔlì;Strive
                爬山;páshān;Mountain climbing
                盘子;pánzi;plate
                胖;pàng;fat
                啤酒;píjiǔ;Beer
                葡萄;pútao;Grape
                普通话;pǔtōnghuà;Mandarin
                其实;qíshí;actually
                其他;qítā;Other
                骑;qí;ride
                奇怪;qíguài;strange
                铅笔;qiānbǐ;pencil
                清楚;qīngchu;clear
                秋;qiū;autumn
                裙子;qúnzi;skirt
                然后;ránhòu;Then
                热情;rèqíng;Enthusiasm
                认为;rènwéi;think
                认真;rènzhēn;earnest
                容易;róngyì;easily
                如果;rúguǒ;If
                伞;sǎn;umbrella
                上网;shàngwǎng;Surf the Internet
                生气;shēngqì;get angry
                声音;shēngyīn;voice
                使;shǐ;send
                世界;shìjiè;world
                瘦;shòu;thin
                舒服;shūfu;comfortable
                叔叔;shūshu;uncle
                树;shù;tree
                数学;shùxué;Mathematics
                刷牙;shuāyá;Brush one's teeth
                双;shuāng;double
                水平;shuǐpíng;level
                司机;sījī;Driver
                虽然;suīrán;although
                太阳;tàiyáng;sunlight
                糖;táng;sugar
                特别;tèbié;Especially
                疼;téng;They hurt
                提高;tígāo;increase
                体育;tǐyù;Sports
                甜;tián;sweet
                条;tiáo;strip
                同事;tóngshì;Colleague
                同意;tóngyì;Agree
                头发;tóufa;Hair
                突然;tūrán;suddenly
                图书馆;túshūguǎn;Library
                腿;tuǐ;leg
                完成;wánchéng;complete
                碗;wǎn;bowl
                万;wàn;ten thousand
                忘记;wàngjì;forget
                为;wèi;by
                为了;wèile;in order to
                位;wèi;position
                文化;wénhuà;Culture
                西;xī;west
                习惯;xíguàn;Habit
                洗手间;xǐshǒujiān;Restroom
                洗澡;xǐzǎo;Take a shower
                夏;xià;summer
                先;xiān;before
                香蕉;xiāngjiāo;Banana
                相同;xiāngtóng;identical
                相信;xiāngxìn;believe
                像;xiàng;image
                小心;xiǎoxīn;Look out
                校长;xiàozhǎng;Principal
                鞋;xié;shoes
                新闻;xīnwén;Journalism
                新鲜;xīnxiān;fresh
                信;xìn;letter
                行李箱;xínglixiāng;Trunk
                兴趣;xìngqù;Interest
                熊猫;xióngmāo;Panda
                需要;xūyào;Need
                选择;xuǎnzé;Choice
                要求;yāoqiú;Requirement
                爷爷;yéye;grandpa
                一定;yídìng;Certain
                一共;yígòng;Altogether
                一会儿;yíhuìr;A little while
                一样;yíyàng;equally
                以后;yǐhòu;In the future
                以前;yǐqián;before
                以为;yǐwéi;Think
                一般;yìbān;commonly
                一边;yìbiān;One side
                一直;yìzhí;always
                阴;yīn;Yin
                音乐;yīnyuè;Music
                银行;yínháng;Bank
                应该;yīnggāi;Should
                影响;yǐngxiǎng;Influence
                用;yòng;use
                游戏;yóuxì;Game
                有名;yǒumíng;Famous
                又;yòu;also
                遇到;yùdào;encounter
                愿意;yuànyì;Be willing
                月亮;yuèliang;Moon
                越;yuè;The more
                云;yún;cloud
                站;zhàn;station
                长;zhǎng;long
                着急;zháojí;Worry
                照顾;zhàogù;look after
                照片;zhàopiàn;Photo
                照相机;zhàoxiàngjī;Camera
                只;zhǐ;only
                中间;zhōngjiān;Middle
                终于;zhōngyú;finally
                种;zhǒng;species
                重要;zhòngyào;important
                周末;zhōumò;Weekend
                主要;zhǔyào;main
                祝;zhù;wish
                注意;zhùyì;Be careful
                字典;zìdiǎn;Dictionaries
                自己;zìjǐ;Own
                总是;zǒngshì;always
                最近;zuìjìn;Lately
                作业;zuòyè;homework
                作用;zuòyòng;Effect
            `;
            
            const vocabList = (dataString) => {
                return dataString.trim().split('\n').map(line => {
                    const parts = line.split(';');
                    if (parts.length < 3) return null;
                    const [front, pinyin, english] = parts;
                    return { front: front.trim(), back: `${pinyin.trim()} - ${english.trim()}` };
                }).filter(Boolean);
            };

            const hsk2Cards = vocabList(hsk2Data);
            const hsk3Cards = vocabList(hsk3Data);

            const addCardsToBatch = async (cards, deckName, updateProgress) => {
                const collectionRef = collection(db, getMasterDeckCollectionPath(deckName));
                const batchSize = 100;
                for (let i = 0; i < cards.length; i += batchSize) {
                    const batch = writeBatch(db);
                    const chunk = cards.slice(i, i + batchSize);
                    chunk.forEach(word => {
                        const newCard = { front: word.front, back: word.back };
                        const cardRef = doc(collectionRef);
                        batch.set(cardRef, newCard);
                    });
                    await batch.commit();
                    if(updateProgress) updateProgress(chunk.length);
                }
            };
            
            let totalCards = hsk2Cards.length + hsk3Cards.length;
            let cardsLoaded = 0;
            const updateProgress = (batchSize) => {
                cardsLoaded += batchSize;
                loginError.textContent = `Building master decks... ${cardsLoaded}/${totalCards}`;
            };
            
            await addCardsToBatch(hsk2Cards, 'hsk2', updateProgress);
            await addCardsToBatch(hsk3Cards, 'hsk3', updateProgress);
            await addCardsToBatch([...hsk2Cards, ...hsk3Cards], 'complete');
            
            console.log('Master decks populated');
        };

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        deckButtons.addEventListener('click', (e) => {
            if (e.target.classList.contains('deck-btn')) handleDeckSelection(e.target.dataset.deck);
        });
        changeDeckBtn.addEventListener('click', handleChangeDeck);
        reviewTabBtn.addEventListener('click', () => switchTab('review'));
        editTabBtn.addEventListener('click', () => switchTab('edit'));
        showAnswerBtn.addEventListener('click', handleShowAnswer);
        ratingButtons.addEventListener('click', (e) => {
            if (e.target.classList.contains('rating-btn')) handleRating(e);
        });
        addCardForm.addEventListener('submit', handleAddCard);
        
        // Add Card Modal Listeners
        openAddCardModalBtn.addEventListener('click', () => addCardModal.classList.remove('hidden'));
        cancelAddBtn.addEventListener('click', () => addCardModal.classList.add('hidden'));

        // Edit/Delete Listeners
        cardListContainer.addEventListener('click', (e) => {
            const target = e.target;
            if(target.classList.contains('edit-card-btn')) {
                openEditModal(target.dataset.id);
            } else if (target.classList.contains('delete-card-btn')) {
                openDeleteConfirm(target.dataset.id);
            }
        });
        cancelEditBtn.addEventListener('click', closeEditModal);
        saveEditBtn.addEventListener('click', handleSaveChanges);
        cancelDeleteBtn.addEventListener('click', closeDeleteConfirm);
        confirmDeleteBtn.addEventListener('click', handleDeleteCard);
        
        // Help Modal Listeners
        helpIcon.addEventListener('click', () => helpModal.classList.remove('hidden'));
        closeHelpBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) helpModal.classList.add('hidden');
        });

        // Settings Modal Listeners
        openSettingsBtn.addEventListener('click', openSettingsModal);
        cancelSettingsBtn.addEventListener('click', closeSettingsModal);
        saveSettingsBtn.addEventListener('click', handleSaveSettings);

        // Teacher Listeners
        teacherAdminLink.addEventListener('click', () => {
            loginOverlay.classList.add('hidden');
            teacherCodeOverlay.classList.remove('hidden');
        });
        
        backFromCodeBtn.addEventListener('click', () => {
            teacherCodeError.textContent = '';
            teacherCodeInput.value = '';
            teacherCodeOverlay.classList.add('hidden');
            loginOverlay.classList.remove('hidden');
        });

        submitTeacherCodeBtn.addEventListener('click', () => {
            const enteredCode = teacherCodeInput.value.trim();
            if (enteredCode === 'WynR29') {
                teacherCodeError.textContent = '';
                teacherCodeInput.value = '';
                teacherCodeOverlay.classList.add('hidden');
                showTeacherDashboard();
            } else {
                teacherCodeError.textContent = 'Incorrect class code.';
            }
        });

        backToLoginScreenBtn.addEventListener('click', hideTeacherDashboard);
        
        studentListContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            const studentId = target.dataset.id;
            const studentName = target.dataset.name;
            
            if(target.classList.contains('view-stats-btn')) {
                toggleStudentStats(studentId);
            } else if (target.classList.contains('delete-student-btn')) {
                openDeleteStudentConfirm(studentId, studentName);
            }
        });
        
        cancelDeleteStudentBtn.addEventListener('click', closeDeleteStudentConfirm);
        confirmDeleteStudentBtn.addEventListener('click', deleteStudentData);

        // --- INITIALIZATION ---
        (async () => {
            await initializeFirebase();
        })();
    </script>
</body>
</html>

